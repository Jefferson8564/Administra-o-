<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‚öôÔ∏è Admin - O Rei da Coxinha</title>
    <link rel="icon" href="icone.png">
    <link rel="apple-touch-icon" href="icone.png">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#c75b24">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --primary: #c75b24; --success: #25d366; --dark: #1a1a2e; --blue: #3498db; --danger: #e74c3c; --warning: #f1c40f; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background: #f0f0f5; min-height: 100vh; }

        /* HEADER */
        .header { background: linear-gradient(135deg, #1a1a2e 0%, #2d1f0e 100%); padding: 18px 20px 14px; color: white; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 15px rgba(0,0,0,0.3); }
        .header-fiado-label { font-size: 11px; opacity: 0.6; text-transform: uppercase; letter-spacing: 1px; display: block; }
        .header-fiado-valor { font-size: 22px; font-weight: 900; color: #ff6b6b; letter-spacing: 0.5px; }
        .header-fiado-valor.zero { color: #2ecc71; }

        /* HOME */
        #homeScreen { display: none; padding: 20px 15px; max-width: 600px; margin: 0 auto; }
        .home-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
        .home-card { background: white; border-radius: 24px; padding: 24px 16px; text-align: center; box-shadow: 0 4px 20px rgba(0,0,0,0.08); cursor: pointer; transition: transform 0.15s, box-shadow 0.15s; border: none; width: 100%; }
        .home-card:active { transform: scale(0.96); }
        .home-card-icon { font-size: 42px; margin-bottom: 10px; display: block; }
        .home-card-label { font-size: 15px; font-weight: 700; color: #333; }
        .home-card-sub { font-size: 12px; color: #999; margin-top: 3px; }
        .home-card.card-orange { border-top: 4px solid var(--primary); }
        .home-card.card-blue { border-top: 4px solid var(--blue); }
        .home-card.card-red { border-top: 4px solid var(--danger); }
        .home-card.card-green { border-top: 4px solid var(--success); }
        .home-store-btn { margin-top: 20px; display: block; text-align: center; text-decoration: none; background: linear-gradient(135deg, #1a1a2e, #c75b24); color: white; padding: 14px; border-radius: 18px; font-weight: 700; font-size: 15px; }

        /* INNER */
        #innerApp { display: none; }
        .section { display: none; padding: 15px; max-width: 600px; margin: 0 auto; }
        .section.active { display: block; }
        .back-area { display: flex; align-items: center; gap: 10px; padding: 12px 15px; background: white; border-bottom: 1px solid #eee; position: sticky; top: 65px; z-index: 89; }
        .back-btn { background: #f0f0f0; border: none; border-radius: 12px; padding: 8px 14px; font-weight: bold; cursor: pointer; font-size: 14px; color: #333; }
        .back-section-title { font-weight: 700; color: var(--primary); font-size: 16px; }

        /* CARDS */
        .card-box { background: white; border-radius: 18px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.06); }
        .card-box h4 { color: var(--primary); margin-bottom: 12px; }
        .input-text { width: 100%; padding: 12px; border: 1.5px solid #e8e8e8; border-radius: 12px; margin-bottom: 10px; font-size: 15px; background: #fafafa; }
        .input-text:focus { outline: none; border-color: var(--primary); }
        .input-prefix-container { position: relative; display: flex; align-items: center; margin-bottom: 10px; }
        .input-prefix-container span { position: absolute; left: 15px; font-weight: bold; color: #555; }
        .input-prefix-container input { padding-left: 50px !important; margin-bottom: 0; }
        .btn { padding: 11px 16px; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; font-size: 14px; transition: 0.2s; }
        .btn:active { opacity: 0.85; transform: scale(0.98); }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-blue { background: var(--blue); color: white; }
        .btn-block { width: 100%; }
        .btn-sm { padding: 7px 12px; font-size: 12px; }

        /* PRODUCT ITEM */
        .prod-item { display: flex; justify-content: space-between; align-items: center; background: #f9f9f9; padding: 12px; border-radius: 14px; margin-bottom: 8px; border: 1px solid #eee; }
        .prod-item img { width: 44px; height: 44px; border-radius: 10px; object-fit: cover; margin-right: 10px; }

        /* CLIENT */
        .client-card { background: white; border: 1px solid #eee; padding: 14px; border-radius: 18px; margin-bottom: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .saldo-positivo { color: var(--blue); font-weight: bold; }
        .saldo-devedor { color: var(--danger); font-weight: bold; }

        /* FIADO BANNER */
        .fiado-banner { background: linear-gradient(135deg, #e74c3c, #c0392b); color: white; padding: 16px 18px; border-radius: 18px; margin-bottom: 16px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 15px rgba(231,76,60,0.35); }
        .fiado-banner.zerado { background: linear-gradient(135deg, #27ae60, #1e8449); box-shadow: 0 4px 15px rgba(39,174,96,0.35); }
        .fb-label { font-size: 12px; opacity: 0.85; text-transform: uppercase; letter-spacing: 1px; }
        .fb-value { font-size: 26px; font-weight: 900; }

        /* ORDER */
        /* SWIPE ORDER CARDS */
        .order-wrap { position: relative; margin-bottom: 8px; border-radius: 18px; overflow: hidden; }
        .order-card {
            background: #fff;
            border-radius: 18px;
            padding: 14px 15px 12px;
            position: relative;
            touch-action: pan-y;
            will-change: transform;
            transition: transform 0.22s cubic-bezier(0.25,0.46,0.45,0.94);
            box-shadow: 0 2px 12px rgba(0,0,0,0.07);
            user-select: none; -webkit-user-select: none;
        }
        
        .order-card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
        .order-card-name { font-size: 15px; font-weight: 800; color: #1a1a2e; }
        .order-card-time { font-size: 11px; color: #bbb; font-weight: 500; }
        .order-card-phone { font-size: 12px; color: #aaa; margin-top: 1px; }
        .order-card-items { font-size: 13px; color: #555; line-height: 1.6; margin-bottom: 10px; }
        .order-card-footer { display: flex; justify-content: space-between; align-items: center; }
        .order-card-valor { font-size: 16px; font-weight: 900; }
        .order-card-badge { font-size: 11px; font-weight: 700; padding: 3px 10px; border-radius: 20px; }
        .badge-fiado { background: #fff0f0; color: #e74c3c; }
        .badge-pago  { background: #e8faf0; color: #27ae60; }
        .order-fiado-btn { margin-top: 10px; width: 100%; padding: 9px; background: #fff8ee; border: 1.5px solid #e67e22; color: #e67e22; border-radius: 12px; font-size: 13px; font-weight: 700; cursor: pointer; }

        /* SWITCH */
        .switch { position: relative; display: inline-block; width: 34px; height: 18px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; inset: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--success); }
        input:checked + .slider:before { transform: translateX(16px); }

        /* TOAST NOTIFICATION */
        #toastContainer { position: fixed; top: 12px; left: 0; right: 0; z-index: 99999; display: flex; flex-direction: column; align-items: center; pointer-events: none; padding: 0 12px; }
        .toast { width: 100%; max-width: 420px; background: rgba(30,30,40,0.92); backdrop-filter: blur(18px); -webkit-backdrop-filter: blur(18px); border-radius: 22px; box-shadow: 0 8px 40px rgba(0,0,0,0.35), 0 2px 8px rgba(0,0,0,0.2); padding: 14px 16px 10px; pointer-events: all; transform: translateY(-130%) scale(0.9); opacity: 0; transition: transform 0.45s cubic-bezier(0.34, 1.45, 0.64, 1), opacity 0.3s ease; overflow: hidden; color: white; }
        .toast.show { transform: translateY(0) scale(1); opacity: 1; }
        .toast-bar { height: 3px; background: rgba(255,255,255,0.12); border-radius: 10px; margin-top: 12px; overflow: hidden; }
        .toast-progress { height: 100%; background: currentColor; border-radius: 10px; animation: toastProgress 8s linear forwards; }
        @keyframes toastProgress { from { width: 100%; } to { width: 0%; } }
        .toast-header { display: flex; justify-content: space-between; align-items: flex-start; gap: 10px; }
        .toast-app-row { display: flex; align-items: center; gap: 7px; margin-bottom: 5px; }
        .toast-app-icon { width: 20px; height: 20px; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 12px; background: rgba(255,255,255,0.15); }
        .toast-app-name { font-size: 11px; opacity: 0.55; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
        .toast-time { font-size: 11px; opacity: 0.45; margin-left: auto; }
        .toast-title { font-weight: 800; font-size: 14px; color: white; line-height: 1.3; }
        .toast-body { font-size: 13px; color: rgba(255,255,255,0.72); margin-top: 4px; white-space: pre-line; line-height: 1.5; }
        .toast-close { background: rgba(255,255,255,0.12); border: none; font-size: 13px; cursor: pointer; color: rgba(255,255,255,0.6); line-height: 1; padding: 4px 7px; border-radius: 20px; flex-shrink: 0; }
        .toast-actions { display: flex; gap: 8px; margin-top: 12px; }
        .toast-btn { flex: 1; padding: 10px; border: none; border-radius: 14px; font-weight: 700; font-size: 14px; cursor: pointer; transition: opacity 0.2s; }
        .toast-btn:active { opacity: 0.8; }
        .toast.success .toast-progress { color: #25d366; }
        .toast.confirm .toast-progress { color: #c75b24; }
    </style>
</head>
<body>

<div id="toastContainer"></div>

<div id="adminApp" style="display:none;">

    <div class="header">
        <div>
            <span class="header-fiado-label">üí∏ Total Pagar Depois</span>
            <span class="header-fiado-valor zero" id="headerFiadoValor">R$ 0,00</span>
        </div>
        <a href="https://jefferson8564.github.io/orei-coxinha/" target="_blank" class="btn btn-sm" style="background:rgba(255,255,255,0.15); color:white; text-decoration:none;">‚Üê Loja</a>
    </div>

    <!-- HOME: cards de navega√ß√£o -->
    <div id="homeScreen">
        <div style="padding: 18px 0 12px; text-align:center; color:#666; font-size:14px; font-weight:600;">Selecione uma op√ß√£o</div>
        <div class="home-grid">
            <button class="home-card" style="border-top:4px solid #16a085; grid-column: span 2;" onclick="openSection('historico')">
                <span class="home-card-icon">üõçÔ∏è</span>
                <div class="home-card-label">Hist√≥rico de Compras</div>
                <div class="home-card-sub">Todas as compras registradas</div>
            </button>
            <button class="home-card" style="border-top:4px solid #8e44ad;" onclick="openSection('refazer')">
                <span class="home-card-icon">ü§ñ</span>
                <div class="home-card-label">Refazer Pedidos</div>
                <div class="home-card-sub">Repetir no pagar depois</div>
            </button>
            <button class="home-card card-blue" onclick="openSection('clientes')">
                <span class="home-card-icon">üë•</span>
                <div class="home-card-label">Clientes</div>
                <div class="home-card-sub">Pagar depois & cadastros</div>
            </button>
            <button class="home-card card-red" onclick="openSection('pedidos')">
                <span class="home-card-icon">üìã</span>
                <div class="home-card-label">Pedidos</div>
                <div class="home-card-sub">Hist√≥rico & vendas</div>
            </button>
            <button class="home-card card-green" onclick="openSection('mensagens')">
                <span class="home-card-icon">‚öôÔ∏è</span>
                <div class="home-card-label">Configura√ß√µes</div>
                <div class="home-card-sub">Templates WhatsApp</div>
            </button>
            <button class="home-card card-orange" onclick="openSection('salgados')">
                <span class="home-card-icon">üçï</span>
                <div class="home-card-label">Salgados</div>
                <div class="home-card-sub">Gerenciar produtos</div>
            </button>
            <button class="home-card" style="border-top:4px solid #e67e22;" onclick="openSection('compra')">
                <span class="home-card-icon">üõí</span>
                <div class="home-card-label">Compra no Nome</div>
                <div class="home-card-sub">Pedido pelo admin</div>
            </button>
            <button class="home-card" style="border-top:4px solid #2980b9; grid-column: span 2;" onclick="openSection('pagamentos')">
                <span class="home-card-icon">üí≥</span>
                <div class="home-card-label">Hist√≥rico de Pagamentos</div>
                <div class="home-card-sub">Abatimentos registrados</div>
            </button>
            <button class="home-card" style="border-top:4px solid #27ae60; grid-column: span 2;" onclick="openSection('rotas')">
                <span class="home-card-icon">üó∫Ô∏è</span>
                <div class="home-card-label">Painel de Rotas</div>
                <div class="home-card-sub">Gerenciar rotas de entrega</div>
            </button>
        </div>
        <a href="https://jefferson8564.github.io/orei-coxinha/" target="_blank" class="home-store-btn">üçó Ir para a Loja</a>
        <a href="https://wa.me/" target="_blank" class="home-store-btn" style="margin-top:10px; background:linear-gradient(135deg, #128C7E, #25d366);">üí¨ Ir para o WhatsApp</a>
    </div>

    <!-- SE√á√ïES INTERNAS -->
    <div id="innerApp">
        <div class="back-area" style="justify-content:space-between;">
            <div style="display:flex; align-items:center; gap:10px;">
                <button class="back-btn" onclick="goHome()">‚Üê Voltar</button>
                <span class="back-section-title" id="sectionTitle"></span>
            </div>
            <button id="btnInativos" onclick="verClientesInativos()" style="display:none; padding:7px 12px; background:#fff3e0; border:1.5px solid #e67e22; color:#e67e22; border-radius:12px; font-size:12px; font-weight:700; cursor:pointer; white-space:nowrap;">
                ‚è∞ Inativos
            </button>
        </div>

        <!-- Modal Clientes Inativos -->
        <div id="modalInativos" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.75); z-index:3000; align-items:center; justify-content:center; padding:15px;">
            <div style="background:white; border-radius:20px; width:100%; max-width:500px; max-height:85vh; overflow-y:auto; padding:20px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <h3 style="color:#e67e22; font-size:17px;">‚è∞ Clientes Inativos (+20 dias)</h3>
                    <button onclick="document.getElementById('modalInativos').style.display='none'" style="background:#f0f0f0; border:none; border-radius:10px; padding:6px 12px; font-weight:bold; cursor:pointer;">‚úï</button>
                </div>
                <div id="inativosList"><div style="text-align:center;color:#888;padding:20px;">Carregando...</div></div>
            </div>
        </div>

        <div id="tab-prods" class="section">
            <div class="card-box">
                <h4 id="prodFormTitle">‚ûï Cadastrar Salgado</h4>
                <input type="hidden" id="editProductId">
                <input type="text" id="newPName" class="input-text" placeholder="Ex: Coxinha de Frango">
                <input type="number" id="newPPrice" class="input-text" placeholder="Pre√ßo (ex: 7.00)" step="0.50">
                <input type="file" id="newPImg" class="input-text" accept="image/*">
                <div style="display:flex; align-items:center; justify-content:space-between; background:#f8f8f8; border-radius:12px; padding:12px 14px; margin-bottom:10px;">
                    <div>
                        <div style="font-weight:700; font-size:14px; color:#333;">Dispon√≠vel no cat√°logo</div>
                        <div style="font-size:12px; color:#999; margin-top:2px;">Se desligado, some do card√°pio</div>
                    </div>
                    <label class="switch"><input type="checkbox" id="newPAvailable" checked><span class="slider"></span></label>
                </div>
                <div style="display:flex; gap:8px;">
                    <button id="btnCancelEdit" onclick="resetProdForm()" style="display:none; background:#ccc;" class="btn">Cancelar</button>
                    <button id="btnSaveProd" onclick="saveProduct()" class="btn btn-primary btn-block">Salvar Produto</button>
                </div>
            </div>
            <div id="adminProductList"></div>
        </div>

        <!-- MODAL DEVOLU√á√ÉO -->
        <div id="modalDevolucao" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.75); z-index:3000; align-items:flex-end; justify-content:center;">
            <div style="background:white; border-radius:24px 24px 0 0; width:100%; max-width:600px; max-height:85vh; overflow-y:auto; padding:20px 18px 30px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:4px;">
                    <h3 style="color:#3498db; font-size:17px;">üí∞ Devolu√ß√£o de Dinheiro</h3>
                    <button onclick="document.getElementById('modalDevolucao').style.display='none'" style="background:#f0f0f0; border:none; border-radius:10px; padding:6px 12px; font-weight:bold; cursor:pointer;">‚úï</button>
                </div>
                <p style="font-size:12px; color:#999; margin-bottom:14px;">Insira o valor a devolver para cada cliente. O valor ser√° descontado do d√©bito deles.</p>
                <div id="devolucaoList" style="display:flex; flex-direction:column; gap:10px;"></div>
            </div>
        </div>

        <div id="tab-clients" class="section">
            <div id="fiadoBanner" class="fiado-banner zerado" style="cursor:pointer; user-select:none; -webkit-user-select:none;">
                <div>
                    <div class="fb-label">üí∏ Total Pagar Depois</div>
                    <div class="fb-value" id="fiadoBannerValor">R$ 0,00</div>
                </div>
                <span style="font-size:36px; opacity:0.25;">üìä</span>
            </div>

            <!-- BARRA DE PESQUISA -->
            <div style="position:relative; margin-bottom:14px;">
                <span style="position:absolute; left:14px; top:50%; transform:translateY(-50%); font-size:18px; pointer-events:none;">üîç</span>
                <input type="text" id="clientSearchInput" class="input-text" placeholder="Pesquisar cliente por nome..."
                    style="padding-left:44px; margin-bottom:0; border-radius:16px; border:2px solid #e0e0e0; font-size:15px;"
                    oninput="filterClients(this.value)">
            </div>
            <div id="clientSearchEmpty" style="display:none; text-align:center; padding:24px; color:#aaa; font-size:14px; background:white; border-radius:16px; margin-bottom:12px;">
                üòï Nenhum cliente encontrado
            </div>

            <div class="card-box">
                <h4>‚ûï Novo Cliente</h4>
                <input type="text" id="newCName" class="input-text" placeholder="Nome Completo">
                <div class="input-prefix-container">
                    <span>819</span>
                    <input type="tel" id="newCPhone" class="input-text" placeholder="Restante do n√∫mero" maxlength="8">
                </div>
                <button onclick="adminAddClient()" class="btn btn-blue btn-block">Cadastrar</button>
            </div>
            <div id="clientList"></div>
        </div>

        <div id="tab-orders" class="section">
            <!-- RESUMO DO DIA -->
            <div id="orderSummaryBox"
                style="background:linear-gradient(135deg,#1a1a2e 0%,#2d1f0e 100%); border-radius:14px; padding:10px 8px; margin-bottom:14px; margin-left:-15px; margin-right:-15px; color:white; box-shadow:0 3px 12px rgba(0,0,0,0.18); position:relative; overflow:hidden; cursor:pointer; user-select:none; -webkit-user-select:none;">
                <div id="orderSummaryGrid" style="display:flex; flex-wrap:nowrap; gap:4px;">
                    <span style="color:rgba(255,255,255,0.4); font-size:13px;">Carregando...</span>
                </div>
                <div id="summaryHoldBar" style="position:absolute; bottom:0; left:0; height:3px; width:0%; background:#f1c40f;"></div>
            </div>

            <!-- MODAL: clientes do per√≠odo -->
            <div id="modalExcluirClientes" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.75); z-index:3000; align-items:flex-end; justify-content:center;">
                <div style="background:white; border-radius:24px 24px 0 0; width:100%; max-width:600px; max-height:80vh; overflow-y:auto; padding:20px 18px 30px;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:4px;">
                        <h3 style="color:#1a1a2e; font-size:17px;">üë§ Remover da contagem</h3>
                        <button onclick="fecharModalExcluir()" style="background:#f0f0f0; border:none; border-radius:10px; padding:6px 12px; font-weight:bold; cursor:pointer;">‚úï</button>
                    </div>
                    <p style="font-size:12px; color:#999; margin-bottom:14px;">Marque os clientes para remover os pedidos deles do cabe√ßalho</p>
                    <div id="excluirClientesList" style="display:flex; flex-direction:column; gap:8px;"></div>
                    <button onclick="aplicarExclusoes()" style="margin-top:16px; width:100%; padding:13px; background:linear-gradient(135deg,#1a1a2e,#c75b24); color:white; border:none; border-radius:14px; font-weight:800; font-size:15px; cursor:pointer;">‚úÖ Aplicar</button>
                </div>
            </div>

            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 style="color:#333;">√öltimos Pedidos</h3>
                <button onclick="clearAllOrders()" class="btn btn-danger btn-sm">Zerar Tudo</button>
            </div>
            <div id="orderList"></div>
        </div>

        <div id="tab-msg" class="section">
            <div class="card-box">
                <h4>üì® Mensagem de Pedido (WhatsApp)</h4>
                <p style="font-size:12px; color:#666; margin-bottom:8px;">Use {nome}, {pedido}, {total}, {pagamento}</p>
                <textarea id="editTemplate" class="input-text" style="height:120px; text-align:left; font-family:monospace;"></textarea>
            </div>
            <div class="card-box">
                <h4>üí∏ Mensagem de Cobran√ßa</h4>
                <p style="font-size:12px; color:#666; margin-bottom:8px;">Use {nome} e {valor}</p>
                <textarea id="editCobrancaTemplate" class="input-text" style="height:120px; text-align:left; font-family:monospace;"></textarea>
            </div>
            <div class="card-box">
                <h4>üßæ Comprovante de Pagamento</h4>
                <p style="font-size:12px; color:#666; margin-bottom:8px;">Use {nome}, {data}, {valor}, {saldo}</p>
                <textarea id="editComprovanteTemplate" class="input-text" style="height:150px; text-align:left; font-family:monospace;"></textarea>
            </div>
            <div class="card-box">
                <h4>üìä Extrato do Pagar Depois</h4>
                <p style="font-size:12px; color:#666; margin-bottom:8px;">Use {nome}, {data}, {saldo}</p>
                <textarea id="editExtratoTemplate" class="input-text" style="height:140px; text-align:left; font-family:monospace;"></textarea>
            </div>
            <button onclick="saveMsgTemplates()" class="btn btn-success btn-block">Salvar Templates</button>
        </div>
        <!-- ABA COMPRA NO NOME -->
        <div id="tab-compra" class="section">
            <div class="card-box">
                <h4>üë§ Selecionar Cliente</h4>
                <select id="compraCliente" class="input-text" onchange="onCompraClienteChange()">
                    <option value="">-- Escolha o cliente --</option>
                </select>
                <div id="compraClienteInfo" style="display:none; background:#f8f8f8; border-radius:12px; padding:10px; margin-bottom:10px; font-size:13px; color:#555;"></div>
            </div>
            <div class="card-box">
                <h4>üì¶ Produtos</h4>
                <div id="compraProdList"></div>
            </div>
            <div style="background:#fff3cd; border-radius:14px; padding:14px; margin-bottom:14px; display:flex; justify-content:space-between; align-items:center;">
                <span style="font-size:14px; color:#555; font-weight:600;">Total</span>
                <span id="compraTotalLabel" style="font-size:24px; font-weight:900; color:var(--primary);">R$ 0,00</span>
            </div>
            <!-- Forma de pagamento -->
            <div style="margin-bottom:14px;">
                <div style="font-size:13px; font-weight:700; color:#555; margin-bottom:8px;">üí≥ Forma de pagamento</div>
                <div style="display:flex; gap:8px;">
                    <div id="cpopt-FIADO" onclick="selecionarPagamentoCompra('FIADO')"
                        style="flex:1; padding:11px; text-align:center; border-radius:12px; border:2px solid var(--success); background:#e8f5e9; color:var(--success); font-weight:700; font-size:14px; cursor:pointer;">
                        ‚è≥ Pagar Depois
                    </div>
                    <div id="cpopt-PAGA-NA-ENTREGA" onclick="selecionarPagamentoCompra('PAGA NA ENTREGA')"
                        style="flex:1; padding:11px; text-align:center; border-radius:12px; border:2px solid #eee; background:white; color:#333; font-weight:700; font-size:14px; cursor:pointer;">
                        ü§ù Pagar na Entrega
                    </div>
                </div>
            </div>
            <button onclick="confirmarCompra()" class="btn btn-success btn-block" style="padding:15px; font-size:16px; margin-bottom:20px;">‚úÖ Confirmar Compra</button>
        </div>

        <!-- Modal Hist√≥rico Execu√ß√µes -->
        <div id="modalHistoricoExec" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.75); z-index:3000; align-items:center; justify-content:center; padding:15px;">
            <div style="background:white; border-radius:20px; width:100%; max-width:500px; max-height:85vh; overflow-y:auto; padding:20px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <h3 style="color:#8e44ad; font-size:17px;">üìã Hist√≥rico de Execu√ß√µes</h3>
                    <button onclick="document.getElementById('modalHistoricoExec').style.display='none'" style="background:#f0f0f0; border:none; border-radius:10px; padding:6px 12px; font-weight:bold; cursor:pointer;">‚úï</button>
                </div>
                <div id="historicoExecList"></div>
            </div>
        </div>

        <!-- ABA REFAZER PEDIDOS -->
        <div id="tab-refazer" class="section">
            <!-- Banner de agendamento autom√°tico -->
            <div id="agendamentoBanner" style="background:linear-gradient(135deg,#1a1a2e,#4a235a);border-radius:18px;padding:16px;margin-bottom:14px;color:white;">
                <div style="display:flex;justify-content:space-between;align-items:center;">
                    <div>
                        <div style="font-weight:800;font-size:15px;">ü§ñ Pedido Autom√°tico √†s 6h</div>
                        <div id="agendamentoStatus" style="font-size:12px;opacity:0.75;margin-top:3px;">Carregando status...</div>
                    </div>
                    <label class="switch" style="transform:scale(1.2);">
                        <input type="checkbox" id="autoRefazerToggle" onchange="toggleAutoRefazer(this.checked)">
                        <span class="slider"></span>
                    </label>
                </div>
                <div id="agendamentoInfo" style="margin-top:10px;font-size:12px;background:rgba(255,255,255,0.1);border-radius:10px;padding:8px 12px;display:none;">
                    ‚úÖ Os clientes <strong>marcados (selecionados)</strong> abaixo ter√£o o pedido lan√ßado automaticamente √†s <strong>06:00</strong> de amanh√£.
                </div>
                <div id="agendamentoUltimo" style="margin-top:8px;font-size:11px;opacity:0.55;display:none;"></div>
            </div>

            <div style="margin-bottom:12px;">
                <p style="color:#888; font-size:13px;">Selecione os clientes para repetir o √∫ltimo pedido no pagar depois:</p>
            </div>
            <div id="refazerList"></div>
            <div id="refazerResumo" style="display:none; position:sticky; bottom:0; background:white; padding:14px; border-top:2px solid #eee; margin-top:10px;">
                <div id="refazerSelecionados" style="font-size:13px; color:#555;"></div>
            </div>
        </div>
        <!-- ABA HIST√ìRICO DE COMPRAS -->
        <div id="tab-historico" class="section">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 style="color:#333;">üõçÔ∏è Todas as Compras</h3>
                <span id="historicoContador" style="background:#16a085; color:white; font-size:12px; font-weight:700; padding:4px 10px; border-radius:20px;"></span>
            </div>
            <!-- Busca -->
            <div style="position:relative; margin-bottom:12px;">
                <span style="position:absolute; left:14px; top:50%; transform:translateY(-50%); font-size:16px; pointer-events:none;">üîç</span>
                <input type="text" id="historicoBusca" class="input-text" placeholder="Buscar por nome do cliente..."
                    style="padding-left:42px; margin-bottom:0; border-radius:16px; border:2px solid #e0e0e0;"
                    oninput="buscarHistorico(this.value)">
            </div>
            <!-- Filtros -->
            <div style="display:flex; gap:8px; margin-bottom:15px; flex-wrap:wrap;">
                <button id="filtro-todos" onclick="filtrarHistorico('todos')" style="flex:1; padding:9px; border-radius:12px; border:2px solid #16a085; background:#16a085; color:white; font-size:13px; font-weight:700; cursor:pointer; white-space:nowrap;">Todos</button>
                <button id="filtro-fiado" onclick="filtrarHistorico('FIADO')" style="flex:1; padding:9px; border-radius:12px; border:2px solid #e74c3c; background:white; color:#e74c3c; font-size:13px; font-weight:700; cursor:pointer; white-space:nowrap;">‚è≥ Pagar Depois</button>
                <button id="filtro-pago" onclick="filtrarHistorico('PAGO')" style="flex:1; padding:9px; border-radius:12px; border:2px solid #27ae60; background:white; color:#27ae60; font-size:13px; font-weight:700; cursor:pointer; white-space:nowrap;">‚úÖ Pago</button>
            </div>
            <div id="historicoList"></div>
            <div id="historicoLoadMore" style="display:none; text-align:center; padding:10px;">
                <button onclick="carregarMaisHistorico()" style="padding:11px 28px; background:#16a085; color:white; border:none; border-radius:14px; font-weight:700; font-size:14px; cursor:pointer;">‚¨áÔ∏è Carregar mais</button>
            </div>
        </div>

        <!-- ABA HIST√ìRICO DE PAGAMENTOS -->
        <div id="tab-pagamentos" class="section">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 style="color:#333;">üí≥ Hist√≥rico de Pagamentos</h3>
                <span id="pagamentosContador" style="background:#2980b9; color:white; font-size:12px; font-weight:700; padding:4px 10px; border-radius:20px;"></span>
            </div>
            <div id="pagamentosTotalBanner" style="background:linear-gradient(135deg,#2980b9,#1a5276);color:white;border-radius:18px;padding:16px 18px;margin-bottom:16px;display:flex;justify-content:space-between;align-items:center;box-shadow:0 4px 15px rgba(41,128,185,0.3);">
                <div>
                    <div style="font-size:12px;opacity:0.8;text-transform:uppercase;letter-spacing:1px;">üí∞ Total Recebido</div>
                    <div id="pagamentosTotalValor" style="font-size:26px;font-weight:900;">R$ 0,00</div>
                </div>
                <span style="font-size:36px;opacity:0.25;">üí≥</span>
            </div>
            <div id="pagamentosList"></div>
        </div>

        <!-- ABA PAINEL DE ROTAS -->
        <div id="tab-rotas" class="section">

            <style>
                @keyframes gpsPulse {
                    0%   { transform:scale(1);   opacity:1; box-shadow:0 0 0 0 rgba(46,204,113,0.7); }
                    70%  { transform:scale(1.3); opacity:0.7; box-shadow:0 0 0 8px rgba(46,204,113,0); }
                    100% { transform:scale(1);   opacity:1; box-shadow:0 0 0 0 rgba(46,204,113,0); }
                }
                @keyframes aguardandoPulse {
                    0%,100% { opacity:1; } 50% { opacity:0.4; }
                }
            </style>

            <!-- STATUS INTELIGENTE DA F√ÅBRICA -->
            <div id="fabricaStatusCard" style="border-radius:18px;padding:16px;margin-bottom:14px;color:white;display:none;">
                <div style="display:flex;align-items:center;gap:12px;">
                    <div style="font-size:32px;" id="fabricaStatusIcon">üè≠</div>
                    <div style="flex:1;">
                        <div style="font-size:15px;font-weight:900;" id="fabricaStatusTitulo">Verificando localiza√ß√£o...</div>
                        <div style="font-size:12px;opacity:0.75;margin-top:3px;" id="fabricaStatusSub"></div>
                    </div>
                    <div id="fabricaDistBadge" style="font-size:11px;font-weight:800;padding:5px 10px;border-radius:20px;background:rgba(255,255,255,0.2);white-space:nowrap;"></div>
                </div>
                <div id="proximaRotaInfo" style="margin-top:10px;padding:10px 12px;background:rgba(255,255,255,0.1);border-radius:12px;font-size:12px;display:none;"></div>
            </div>

            <!-- GPS TRANSMITINDO -->
            <div id="gpsTransmitindoBanner" style="display:none;background:linear-gradient(135deg,#1a1a2e,#0d3b1e);border-radius:18px;padding:16px;margin-bottom:14px;color:white;box-shadow:0 4px 20px rgba(0,0,0,0.4);border:1px solid rgba(39,174,96,0.4);">
                <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;">
                    <div style="display:flex;align-items:center;gap:12px;">
                        <div style="position:relative;width:46px;height:46px;flex-shrink:0;">
                            <div style="width:46px;height:46px;border-radius:50%;background:linear-gradient(135deg,#27ae60,#1e8449);display:flex;align-items:center;justify-content:center;font-size:22px;">üõµ</div>
                            <div style="position:absolute;top:0;right:0;width:14px;height:14px;border-radius:50%;background:#2ecc71;border:2px solid #1a1a2e;animation:gpsPulse 1.2s ease-in-out infinite;"></div>
                        </div>
                        <div>
                            <div style="font-size:14px;font-weight:900;" id="gpsRotaNomeAtiva">GPS Ativo</div>
                            <div id="gpsUltimaPos" style="font-size:11px;color:rgba(255,255,255,0.55);margin-top:2px;">Aguardando sinal...</div>
                        </div>
                    </div>
                    <button onclick="encerrarRotaManual()" style="background:rgba(231,76,60,0.25);border:1px solid rgba(231,76,60,0.5);color:#ff6b6b;padding:8px 12px;border-radius:12px;font-weight:700;cursor:pointer;font-size:12px;">‚úÖ Encerrar</button>
                </div>
                <div id="gpsContadorEnvios" style="margin-top:10px;font-size:11px;color:rgba(255,255,255,0.4);padding:6px 10px;background:rgba(255,255,255,0.05);border-radius:8px;">0 atualiza√ß√µes enviadas</div>
                <!-- Paradas em andamento -->
                <div id="paradasEmAndamentoList" style="margin-top:10px;display:flex;flex-direction:column;gap:6px;"></div>
            </div>

            <!-- CRIAR NOVA ROTA -->
            <div class="card-box">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
                    <h4 style="margin-bottom:0;">üó∫Ô∏è Rotas do Dia</h4>
                    <button onclick="toggleNovaRota()" id="btnToggleNovaRota" style="padding:7px 14px;background:linear-gradient(135deg,#27ae60,#1e8449);color:white;border:none;border-radius:12px;font-size:13px;font-weight:700;cursor:pointer;">‚ûï Nova</button>
                </div>

                <!-- Lista de rotas configuradas hoje -->
                <div id="rotasHojeList" style="display:flex;flex-direction:column;gap:8px;margin-bottom:12px;"></div>

                <!-- Formul√°rio nova rota (colaps√°vel) -->
                <div id="novaRotaForm" style="display:none;border-top:1px solid #eee;padding-top:14px;margin-top:4px;">
                    <input type="text" id="rotaNome" class="input-text" placeholder="Nome da rota (ex: Rota 1 ‚Äî Manh√£)">
                    <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;">
                        <div style="flex:1;">
                            <div style="font-size:11px;font-weight:700;color:#555;margin-bottom:5px;">‚è∞ Hor√°rio de sa√≠da</div>
                            <input type="time" id="rotaHoraSaida" class="input-text" style="margin-bottom:0;" value="05:20">
                        </div>
                        <div style="flex:1;">
                            <div style="font-size:11px;font-weight:700;color:#555;margin-bottom:5px;">üìç Raio f√°brica (m)</div>
                            <input type="number" id="rotaRaio" class="input-text" style="margin-bottom:0;" value="20">
                        </div>
                    </div>
                    <div style="margin-bottom:10px;">
                        <div style="font-size:11px;font-weight:700;color:#555;margin-bottom:6px;">üìÖ Dias da semana</div>
                        <div style="display:grid;grid-template-columns:repeat(7,1fr);gap:4px;">
                            <div onclick="toggleDia(this,'Dom')" data-dia="Dom" style="text-align:center;padding:9px 3px;border-radius:10px;border:2px solid #eee;background:#fafafa;cursor:pointer;transition:0.2s;"><div style="font-size:10px;font-weight:700;color:#aaa;">Dom</div></div>
                            <div onclick="toggleDia(this,'Seg')" data-dia="Seg" style="text-align:center;padding:9px 3px;border-radius:10px;border:2px solid #eee;background:#fafafa;cursor:pointer;transition:0.2s;"><div style="font-size:10px;font-weight:700;color:#aaa;">Seg</div></div>
                            <div onclick="toggleDia(this,'Ter')" data-dia="Ter" style="text-align:center;padding:9px 3px;border-radius:10px;border:2px solid #eee;background:#fafafa;cursor:pointer;transition:0.2s;"><div style="font-size:10px;font-weight:700;color:#aaa;">Ter</div></div>
                            <div onclick="toggleDia(this,'Qua')" data-dia="Qua" style="text-align:center;padding:9px 3px;border-radius:10px;border:2px solid #eee;background:#fafafa;cursor:pointer;transition:0.2s;"><div style="font-size:10px;font-weight:700;color:#aaa;">Qua</div></div>
                            <div onclick="toggleDia(this,'Qui')" data-dia="Qui" style="text-align:center;padding:9px 3px;border-radius:10px;border:2px solid #eee;background:#fafafa;cursor:pointer;transition:0.2s;"><div style="font-size:10px;font-weight:700;color:#aaa;">Qui</div></div>
                            <div onclick="toggleDia(this,'Sex')" data-dia="Sex" style="text-align:center;padding:9px 3px;border-radius:10px;border:2px solid #eee;background:#fafafa;cursor:pointer;transition:0.2s;"><div style="font-size:10px;font-weight:700;color:#aaa;">Sex</div></div>
                            <div onclick="toggleDia(this,'S√°b')" data-dia="S√°b" style="text-align:center;padding:9px 3px;border-radius:10px;border:2px solid #eee;background:#fafafa;cursor:pointer;transition:0.2s;"><div style="font-size:10px;font-weight:700;color:#aaa;">S√°b</div></div>
                        </div>
                    </div>
                    <button onclick="criarRota()" class="btn btn-success btn-block">‚ûï Criar Rota</button>
                </div>
            </div>

            <!-- ADICIONAR PARADAS -->
            <div id="addParadaBox" class="card-box" style="display:none;">
                <h4>üìç Adicionar Parada ‚Äî <span id="addParadaRotaNome" style="color:#27ae60;"></span></h4>
                <div style="margin-bottom:10px;">
                    <label style="font-size:12px;font-weight:700;color:#555;display:block;margin-bottom:6px;">üë§ Cliente</label>
                    <select id="paradaCliente" class="input-text" onchange="onParadaClienteChange()" style="margin-bottom:0;">
                        <option value="">-- Selecionar cliente --</option>
                    </select>
                    <div id="paradaClienteInfo" style="display:none;font-size:12px;color:#888;padding:6px 10px;background:#f8f8f8;border-radius:8px;margin-top:6px;"></div>
                </div>
                <div style="margin-bottom:10px;">
                    <label style="font-size:12px;font-weight:700;color:#555;display:block;margin-bottom:6px;">üè† Endere√ßo</label>
                    <input type="text" id="paradaEndereco" class="input-text" placeholder="Rua, n√∫mero, bairro..." style="margin-bottom:6px;">
                    <button onclick="usarEnderecoAtual()" style="width:100%;padding:10px;background:#f0f8ff;border:2px dashed #3498db;border-radius:12px;color:#2980b9;font-weight:700;font-size:13px;cursor:pointer;">üìç Usar minha localiza√ß√£o atual</button>
                </div>
                <div style="display:flex;gap:8px;margin-bottom:10px;">
                    <input type="number" id="paradaLat" class="input-text" placeholder="Latitude" style="flex:1;margin-bottom:0;font-size:12px;">
                    <input type="number" id="paradaLon" class="input-text" placeholder="Longitude" style="flex:1;margin-bottom:0;font-size:12px;">
                </div>
                <div id="paradaEtaPreview" style="display:none;background:#f0fff4;border:1px solid #27ae60;border-radius:12px;padding:10px 12px;margin-bottom:10px;">
                    <div style="font-size:11px;font-weight:700;color:#27ae60;">‚è±Ô∏è ETA Estimado</div>
                    <div id="paradaEtaValor" style="font-size:18px;font-weight:900;color:#1e8449;">-- min</div>
                    <div id="paradaEtaHistorico" style="font-size:11px;color:#555;margin-top:2px;"></div>
                </div>
                <div style="display:flex;gap:8px;">
                    <button onclick="fecharAddParada()" class="btn" style="background:#f0f0f0;color:#555;flex:1;">Cancelar</button>
                    <button onclick="adicionarParada()" class="btn btn-blue" style="flex:2;">+ Adicionar</button>
                </div>
            </div>

            <!-- PARADAS DA ROTA SELECIONADA -->
            <div id="rotaAtualBox" class="card-box" style="display:none;">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
                    <h4 style="margin-bottom:0;">üìã <span id="rotaAtualNomeLabel"></span></h4>
                    <button onclick="fecharRotaAtual()" style="background:#f0f0f0;border:none;border-radius:10px;padding:6px 12px;font-size:12px;font-weight:700;cursor:pointer;color:#555;">‚úï Fechar</button>
                </div>
                <div id="rotaParadasList" style="display:flex;flex-direction:column;gap:8px;"></div>
                <div id="rotaResumoEta" style="margin-top:12px;padding:12px;background:#f8fff8;border-radius:12px;border:1px solid #d5f5e3;font-size:13px;color:#555;display:none;">
                    <strong>üìä Resumo:</strong> <span id="rotaResumoTexto"></span>
                </div>
            </div>

            <!-- ROTAS SALVAS -->
            <div class="card-box">
                <h4>üìÅ Rotas Salvas</h4>
                <div id="rotasSalvasList" style="color:#888;font-size:13px;text-align:center;padding:20px;">Carregando...</div>
            </div>
        </div>
    </div>

<script>
const SUPABASE_URL = "https://vpeyqgijajywgswmezlh.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZwZXlxZ2lqYWp5d2dzd21lemxoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEyNTM1MDIsImV4cCI6MjA4NjgyOTUwMn0.LA5Cbof7IKWAA7l8YbCuPzANpCy0rX_Dro4l9fcDgoQ";
const ADMIN_NUM = "81996603348";
const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
let msgTemplate = "*NOVO PEDIDO*\nCliente: {nome}\n\n{pedido}\nTotal: R$ {total}\nPagamento: {pagamento}";
let msgCobranca = "Ol√° {nome}, tudo bem? Passando para lembrar do seu d√©bito pendente no valor de *R$ {valor}*. Como prefere pagar?";
let msgComprovante = "üßæ *COMPROVANTE DE PAGAMENTO*\n*O Rei da Coxinha* üçó\n‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\nüë§ Cliente: {nome}\nüìÖ Data/Hora: {data}\nüí∞ Valor pago: R$ {valor}\n{saldo}\n‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n‚úÖ Obrigado pelo pagamento!";
let msgExtrato = "üìä *EXTRATO DE PAGAR DEPOIS*\n*O Rei da Coxinha* üçó\n‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\nüë§ Cliente: {nome}\nüìÖ Consultado em: {data}\nüí∏ Saldo devedor: R$ {saldo}\n‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\nQualquer d√∫vida, entre em contato! üòä";

window.onload = async () => {
    initAdmin();
};

async function initAdmin() {
    document.getElementById('adminApp').style.display = 'block';
    document.getElementById('homeScreen').style.display = 'block';
    await loadTemplates();
    await updateFiadoHeader();
    // Inicia GPS e monitor de rotas automaticamente ao abrir o app
    await iniciarMonitorBackground();
}

async function iniciarMonitorBackground() {
    // Carrega dados necess√°rios para o monitor funcionar
    const { data: clients } = await sb.from("clients").select("*").order("name");
    clientesCache = clients || [];
    await calcularMediaEta();
    await carregarRotasHoje();
    iniciarMonitorFabrica();
}

async function updateFiadoHeader() {
    const { data } = await sb.from("clients").select("debt");
    const total = (data || []).filter(c => c.debt > 0).reduce((s, c) => s + c.debt, 0);
    const el = document.getElementById('headerFiadoValor');
    el.textContent = 'R$ ' + total.toFixed(2).replace('.', ',');
    el.className = 'header-fiado-valor' + (total > 0 ? '' : ' zero');
}

function openSection(section) {
    document.getElementById('homeScreen').style.display = 'none';
    document.getElementById('innerApp').style.display = 'block';
    document.querySelectorAll('#innerApp .section').forEach(s => s.classList.remove('active'));
    const map = {
        salgados:  { id: 'tab-prods',   title: 'üçï Salgados',   fn: loadAdminProducts },
        clientes:  { id: 'tab-clients', title: 'üë• Clientes',   fn: loadAdminClients },
        pedidos:   { id: 'tab-orders',  title: 'üìã Pedidos',    fn: () => { loadOrders(); setTimeout(initSummaryHold, 100); } },
        mensagens: { id: 'tab-msg',     title: 'üí¨ Mensagens',  fn: () => {
            document.getElementById('editTemplate').value = msgTemplate;
            document.getElementById('editCobrancaTemplate').value = msgCobranca;
            document.getElementById('editComprovanteTemplate').value = msgComprovante;
            document.getElementById('editExtratoTemplate').value = msgExtrato;
        }},
        refazer: { id: 'tab-refazer', title: 'üîÅ Refazer Pedidos', fn: loadRefazerPedidos },
        compra:  { id: 'tab-compra',   title: 'üõí Compra no Nome',  fn: loadCompraTab },
        historico: { id: 'tab-historico', title: 'üõçÔ∏è Hist√≥rico de Compras', fn: loadHistoricoFiado },
        pagamentos: { id: 'tab-pagamentos', title: 'üí≥ Hist√≥rico de Pagamentos', fn: loadHistoricoPagamentos },
        rotas: { id: 'tab-rotas', title: 'üó∫Ô∏è Painel de Rotas', fn: loadRotasPanel }
    };
    const s = map[section];
    document.getElementById(s.id).classList.add('active');
    document.getElementById('sectionTitle').textContent = s.title;
    // Mostra bot√£o de inativos apenas na aba clientes
    document.getElementById('btnInativos').style.display = section === 'clientes' ? 'block' : 'none';
    s.fn();
}

function goHome() {
    document.getElementById('innerApp').style.display = 'none';
    document.getElementById('homeScreen').style.display = 'block';
    document.getElementById('btnInativos').style.display = 'none';
    updateFiadoHeader();
}

async function verClientesInativos() {
    const modal = document.getElementById('modalInativos');
    const list = document.getElementById('inativosList');
    modal.style.display = 'flex';
    list.innerHTML = '<div style="text-align:center;color:#888;padding:20px;">Carregando...</div>';

    // Busca todos os clientes
    const { data: clients } = await sb.from("clients").select("*").order("name");
    if (!clients || clients.length === 0) {
        list.innerHTML = '<div style="text-align:center;color:#aaa;padding:30px;">Nenhum cliente cadastrado.</div>';
        return;
    }

    const limite = new Date();
    limite.setDate(limite.getDate() - 20);

    // Para cada cliente, busca o √∫ltimo pedido
    const resultados = await Promise.all(clients.map(async c => {
        const { data: orders } = await sb.from("orders")
            .select("created_at")
            .eq("customer_phone", c.phone)
            .order("created_at", { ascending: false })
            .limit(1);
        const ultimo = orders && orders.length > 0 ? new Date(orders[0].created_at) : null;
        return { client: c, ultimaCompra: ultimo };
    }));

    // Filtra inativos (sem compra nos √∫ltimos 20 dias ou nunca compraram)
    const inativos = resultados.filter(({ ultimaCompra }) => !ultimaCompra || ultimaCompra < limite);

    if (inativos.length === 0) {
        list.innerHTML = '<div style="text-align:center;padding:30px;font-size:15px;">‚úÖ Nenhum cliente inativo! Todos compraram nos √∫ltimos 20 dias.</div>';
        return;
    }

    list.innerHTML = inativos.map(({ client: c, ultimaCompra }) => {
        const diasStr = ultimaCompra
            ? (() => { const d = Math.floor((new Date() - ultimaCompra) / 86400000); return `√öltima compra h√° <strong>${d} dias</strong>`; })()
            : '<strong>Nunca comprou</strong>';
        const debtColor = c.debt > 0 ? '#e74c3c' : '#27ae60';
        const debtText = c.debt > 0 ? `D√©bito: R$ ${c.debt.toFixed(2)}` : c.debt < 0 ? `Cr√©dito: R$ ${Math.abs(c.debt).toFixed(2)}` : 'Sem d√≠vida';
        return `
        <div style="background:#fafafa; border:1px solid #eee; border-radius:14px; padding:14px; margin-bottom:10px; border-left:4px solid #e67e22;">
            <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                <div>
                    <div style="font-weight:800; font-size:15px;">${c.name}</div>
                    <div style="font-size:12px; color:#999; margin-top:2px;">${c.phone}</div>
                </div>
                <button onclick="cobrarClienteInativo('${c.phone}','${c.name.replace(/'/g,"\'")}',${c.debt})"
                    style="padding:6px 12px; background:#25d366; border:none; border-radius:10px; color:white; font-size:12px; font-weight:700; cursor:pointer;">
                    üì± Cobrar
                </button>
            </div>
            <div style="margin-top:8px; font-size:13px; color:#666;">${diasStr}</div>
            <div style="margin-top:4px; font-size:13px; color:${debtColor}; font-weight:bold;">${debtText}</div>
        </div>`;
    }).join('');
}

function cobrarClienteInativo(phone, name, debt) {
    if (debt <= 0) {
        window.open('https://api.whatsapp.com/send?phone=55' + phone + '&text=' + encodeURIComponent('Oi ' + name + '! Sentimos sua falta por aqui üòä Que tal pedir hoje?'), '_blank');
    } else {
        cobrarCliente(phone, name, debt);
    }
}

// PRODUTOS
async function loadAdminProducts() {
    const { data } = await sb.from("products").select("*").order("created_at", { ascending: true });
    const list = document.getElementById('adminProductList');
    if (!data || data.length === 0) { list.innerHTML = '<div style="text-align:center;color:#888;padding:20px;">Nenhum produto</div>'; return; }
    list.innerHTML = data.map(p => `
        <div class="prod-item" style="opacity:${p.available === false ? '0.55' : '1'}; border:1px solid ${p.available === false ? '#ffcccc' : '#eee'};">
            <div style="display:flex;align-items:center;flex:1;">
                ${p.image_url ? `<img src="${p.image_url}">` : '<div style="width:44px;height:44px;border-radius:10px;background:#1a1a2e;display:flex;align-items:center;justify-content:center;margin-right:10px;font-size:22px;">ü•ü</div>'}
                <div>
                    <strong>${p.name}</strong>
                    <span style="font-size:11px;padding:2px 7px;border-radius:20px;margin-left:5px;${p.available === false ? 'background:#ffcccc;color:#c0392b;' : 'background:#d5f5e3;color:#1e8449;'}">${p.available === false ? 'Indispon√≠vel' : 'Dispon√≠vel'}</span>
                    <br><span style="color:var(--primary);">R$ ${Number(p.price).toFixed(2)}</span>
                </div>
            </div>
            <div style="display:flex;align-items:center;gap:8px;">
                <label class="switch" title="Ativar/desativar no cat√°logo">
                    <input type="checkbox" ${p.available === false ? '' : 'checked'} onchange="toggleAvailable('${p.id}', this.checked)">
                    <span class="slider"></span>
                </label>
                <button onclick="editProduct('${p.id}')" class="btn btn-sm" style="background:#f0f0f0;">‚úèÔ∏è</button>
                <button onclick="removeProduct('${p.id}')" class="btn btn-danger btn-sm">üóëÔ∏è</button>
            </div>
        </div>`).join('');
}

async function editProduct(id) {
    const { data: p } = await sb.from("products").select("*").eq("id", id).single();
    document.getElementById('editProductId').value = p.id;
    document.getElementById('newPName').value = p.name;
    document.getElementById('newPPrice').value = p.price;
    document.getElementById('newPAvailable').checked = p.available !== false;
    document.getElementById('prodFormTitle').textContent = "‚úèÔ∏è Editar Salgado";
    document.getElementById('btnCancelEdit').style.display = "block";
    document.getElementById('btnSaveProd').textContent = "Atualizar";
    window.scrollTo(0, 0);
}

function resetProdForm() {
    document.getElementById('editProductId').value = "";
    document.getElementById('newPName').value = "";
    document.getElementById('newPPrice').value = "";
    document.getElementById('newPImg').value = "";
    document.getElementById('newPAvailable').checked = true;
    document.getElementById('prodFormTitle').textContent = "‚ûï Cadastrar Salgado";
    document.getElementById('btnCancelEdit').style.display = "none";
    document.getElementById('btnSaveProd').textContent = "Salvar Produto";
}

async function saveProduct() {
    const id = document.getElementById('editProductId').value;
    const name = document.getElementById('newPName').value.trim();
    const price = parseFloat(document.getElementById('newPPrice').value);
    const available = document.getElementById('newPAvailable').checked;
    const file = document.getElementById('newPImg').files[0];
    if (!name || !price) { showToast({ type:'confirm', title:'‚ö†Ô∏è Aten√ß√£o', body:'Preencha nome e pre√ßo do produto!' }); return; }
    const btn = document.getElementById('btnSaveProd');
    btn.disabled = true; btn.textContent = "Salvando...";
    let imageUrl = null;
    if (file) {
        const fileName = Date.now() + "_" + file.name.replace(/\s/g, '_');
        const { error: uploadErr } = await sb.storage.from("products").upload(fileName, file);
        if (uploadErr) { showToast({ type:'confirm', title:'‚ùå Erro ao enviar imagem', body: uploadErr.message }); btn.disabled = false; btn.textContent = "Salvar Produto"; return; }
        imageUrl = `${SUPABASE_URL}/storage/v1/object/public/products/${fileName}`;
    }
    if (id) {
        const updates = { name, price, available };
        if (imageUrl) updates.image_url = imageUrl;
        await sb.from("products").update(updates).eq("id", id);
    } else {
        await sb.from("products").insert({ name, price, available, image_url: imageUrl });
    }
    resetProdForm(); loadAdminProducts();
    btn.disabled = false; btn.textContent = "Salvar Produto";
}

async function removeProduct(id) {
    showToast({
        type: 'confirm',
        title: 'üóëÔ∏è Excluir produto?',
        body: 'Esta a√ß√£o n√£o pode ser desfeita.',
        actions: [
            { label: 'Cancelar', bg: '#f0f0f0', color: '#555', fn: 'closeToast()' },
            { label: 'üóëÔ∏è Excluir', bg: 'var(--danger)', color: 'white', fn: `executarRemoveProduct('${id}')` }
        ],
        duration: 8000
    });
}
async function executarRemoveProduct(id) {
    closeToast();
    await sb.from("products").delete().eq("id", id);
    loadAdminProducts();
    showToast({ type: 'success', title: '‚úÖ Produto removido!', body: 'O produto foi exclu√≠do do cat√°logo.', duration: 4000 });
}

async function toggleAvailable(id, value) {
    await sb.from("products").update({ available: value }).eq("id", id);
    loadAdminProducts();
}

// CLIENTES
async function loadAdminClients() {
    const { data: rawData } = await sb.from("clients").select("*").order("name");
    const data = (rawData || []).sort((a, b) => {
        if (b.debt > 0 && a.debt <= 0) return 1;
        if (a.debt > 0 && b.debt <= 0) return -1;
        return b.debt - a.debt;
    });
    const list = document.getElementById('clientList');
    const total = (data || []).filter(c => c.debt > 0).reduce((s, c) => s + c.debt, 0);
    document.getElementById('fiadoBannerValor').textContent = 'R$ ' + total.toFixed(2).replace('.', ',');
    document.getElementById('fiadoBanner').className = 'fiado-banner' + (total > 0 ? '' : ' zerado');
    const el = document.getElementById('headerFiadoValor');
    el.textContent = 'R$ ' + total.toFixed(2).replace('.', ',');
    el.className = 'header-fiado-valor' + (total > 0 ? '' : ' zero');
    if (!data || data.length === 0) { list.innerHTML = '<div style="text-align:center;color:#888;padding:20px;">Nenhum cliente</div>'; return; }
    list.innerHTML = data.map(c => `
        <div class="client-card" data-name="${c.name.toLowerCase()}">
            <div style="display:flex;justify-content:space-between;align-items:start;">
                <div><strong>${c.name}</strong><br><small style="color:#888;">${c.phone}</small></div>
                <div style="text-align:right;display:flex;flex-direction:column;align-items:flex-end;gap:6px;">
                    <div style="display:flex;align-items:center;gap:6px;">
                        <small>PAGAR DEPOIS</small>
                        <label class="switch"><input type="checkbox" ${c.fiado === false ? '' : 'checked'} onchange="toggleFiado('${c.phone}', this.checked)"><span class="slider"></span></label>
                    </div>
                    <button onclick="deleteClient('${c.phone}')" class="btn btn-danger btn-sm">üóëÔ∏è</button>
                </div>
            </div>
            <div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px;">
                <div class="${c.debt > 0 ? 'saldo-devedor' : 'saldo-positivo'}" style="font-size:17px;">
                    ${c.debt > 0 ? 'D√©bito: R$ ' + c.debt.toFixed(2) : c.debt < 0 ? 'Cr√©dito: R$ ' + Math.abs(c.debt).toFixed(2) : 'Saldo: R$ 0,00'}
                </div>
                ${c.debt > 0 ? `<button class="btn btn-success btn-sm" onclick="cobrarCliente('${c.phone}','${c.name.replace(/'/g,"\\'")}',${c.debt})">üì± Cobrar</button>` : ''}
            </div>
            <div style="display:flex;gap:8px;margin-top:10px;">
                <input type="number" id="pay_${c.phone}" class="input-text" style="margin:0;" placeholder="Valor a lan√ßar">
                <button onclick="payDebt('${c.phone}')" class="btn btn-success">OK</button>
            </div>
        </div>`).join('');

    // Limpa pesquisa ao recarregar
    const searchInput = document.getElementById('clientSearchInput');
    if (searchInput) { searchInput.value = ''; filterClients(''); }
}

function filterClients(query) {
    const q = query.toLowerCase().trim();
    const cards = document.querySelectorAll('#clientList .client-card');
    let visibleCount = 0;
    cards.forEach(card => {
        const name = card.getAttribute('data-name') || '';
        const match = name.includes(q);
        card.style.display = match ? '' : 'none';
        if (match) visibleCount++;
    });
    const emptyMsg = document.getElementById('clientSearchEmpty');
    if (emptyMsg) emptyMsg.style.display = (visibleCount === 0 && q.length > 0) ? 'block' : 'none';
}

async function adminAddClient() {
    const name = document.getElementById('newCName').value.trim();
    const partial = document.getElementById('newCPhone').value.replace(/\D/g,'');
    if (!name || partial.length < 8) { showToast({ type:'confirm', title:'‚ö†Ô∏è Aten√ß√£o', body:'Preencha o nome e o n√∫mero completo (819 + 8 d√≠gitos).' }); return; }
    const phone = "819" + partial;
    await sb.from("clients").upsert({ name, phone, fiado: true, debt: 0 });
    document.getElementById('newCName').value = '';
    document.getElementById('newCPhone').value = '';
    loadAdminClients();
}

async function toggleFiado(phone, value) {
    await sb.from("clients").update({ fiado: value }).eq("phone", phone);
}

// Vari√°vel global tempor√°ria para guardar o comprovante pendente de envio
let _comprovanteTemp = { phone: null, texto: null };

async function payDebt(phone) {
    const input = document.getElementById('pay_' + phone);
    const digitado = parseFloat(input.value);
    const { data: c } = await sb.from("clients").select("debt, name").eq("phone", phone).single();
    if (!digitado) {
        // Campo vazio: confirmar quita√ß√£o total
        if (!c.debt || c.debt <= 0) { showToast({ type:'confirm', title:'‚ö†Ô∏è Aten√ß√£o', body:'N√£o h√° valor de d√©bito para abater.' }); return; }
        showToast({
            type: 'confirm',
            title: `üí∞ Quitar total de ${c.name}?`,
            body: `Nenhum valor foi digitado.\nDeseja abater o d√©bito total de R$ ${c.debt.toFixed(2).replace('.', ',')}?`,
            actions: [
                { label: 'Cancelar', bg: '#f0f0f0', color: '#555', fn: 'closeToast()' },
                { label: '‚úÖ Confirmar', bg: '#25d366', color: 'white', fn: `executarPayDebt('${phone}', ${c.debt})` }
            ],
            duration: 10000
        });
        return;
    }
    executarPayDebt(phone, digitado);
}

async function executarPayDebt(phone, val) {
    closeToast();
    const input = document.getElementById('pay_' + phone);
    const { data: c } = await sb.from("clients").select("debt, name").eq("phone", phone).single();
    const novoSaldo = c.debt - val;
    await sb.from("clients").update({ debt: novoSaldo }).eq("phone", phone);

    // Registra o pagamento na tabela payments do Supabase
    await sb.from("payments").insert({
        client_name: c.name,
        client_phone: phone,
        amount: val,
        saldo_anterior: c.debt,
        saldo_posterior: novoSaldo,
        tipo: "pagamento"
    });

    if (input) input.value = '';
    loadAdminClients();

    // Monta o comprovante usando o template configur√°vel
    const now = new Date();
    const dataHora = now.toLocaleString('pt-BR', { day:'2-digit', month:'2-digit', year:'numeric', hour:'2-digit', minute:'2-digit' });
    const saldoTexto = novoSaldo > 0
        ? `Saldo devedor restante: R$ ${novoSaldo.toFixed(2).replace('.', ',')}`
        : novoSaldo < 0
            ? `Cr√©dito a favor: R$ ${Math.abs(novoSaldo).toFixed(2).replace('.', ',')}`
            : `‚úÖ Pagar depois quitado completamente!`;

    const comprovante = msgComprovante
        .replace('{nome}', c.name)
        .replace('{data}', dataHora)
        .replace('{valor}', val.toFixed(2).replace('.', ','))
        .replace('{saldo}', saldoTexto);

    // Guarda na vari√°vel global para o bot√£o do toast acessar com seguran√ßa
    _comprovanteTemp = { phone, texto: comprovante };

    showToast({
        type: 'success',
        title: `üí∞ Pagamento de R$ ${val.toFixed(2).replace('.', ',')} registrado!`,
        body: `Deseja enviar o comprovante para ${c.name} no WhatsApp?`,
        actions: [
            { label: '‚ùå N√£o', bg: '#f0f0f0', color: '#555', fn: 'closeToast()' },
            { label: 'üì≤ Enviar Comprovante', bg: '#25d366', color: 'white', fn: 'enviarComprovanteWpp()' }
        ],
        duration: 10000
    });
}

function enviarComprovanteWpp() {
    const { phone, texto } = _comprovanteTemp;
    closeToast();
    if (!phone || !texto) return;
    window.open(`https://api.whatsapp.com/send?phone=55${phone}&text=${encodeURIComponent(texto)}`, '_blank');
    _comprovanteTemp = { phone: null, texto: null };
}

function enviarComprovanteManual(phone, name, debt) {
    const now = new Date();
    const dataHora = now.toLocaleString('pt-BR', { day:'2-digit', month:'2-digit', year:'numeric', hour:'2-digit', minute:'2-digit' });
    const extrato = msgExtrato
        .replace('{nome}', name)
        .replace('{data}', dataHora)
        .replace('{saldo}', Number(debt).toFixed(2).replace('.', ','));
    window.open(`https://api.whatsapp.com/send?phone=55${phone}&text=${encodeURIComponent(extrato)}`, '_blank');
}

async function deleteClient(phone) {
    if (phone === ADMIN_NUM) { showToast({ type:'confirm', title:'‚ö†Ô∏è Aten√ß√£o', body:'N√£o √© poss√≠vel remover o administrador!' }); return; }
    showToast({
        type: 'confirm',
        title: 'üóëÔ∏è Remover cliente?',
        body: 'O cliente e seus dados ser√£o removidos permanentemente.',
        actions: [
            { label: 'Cancelar', bg: '#f0f0f0', color: '#555', fn: 'closeToast()' },
            { label: 'üóëÔ∏è Remover', bg: 'var(--danger)', color: 'white', fn: `executarDeleteClient('${phone}')` }
        ],
        duration: 8000
    });
}
async function executarDeleteClient(phone) {
    closeToast();
    await sb.from("clients").delete().eq("phone", phone);
    loadAdminClients();
    showToast({ type: 'success', title: '‚úÖ Cliente removido!', body: 'O cliente foi removido com sucesso.', duration: 4000 });
}

function cobrarCliente(phone, name, debt) {
    const texto = msgCobranca.replace('{nome}', name).replace('{valor}', debt.toFixed(2).replace('.', ','));
    window.open(`https://api.whatsapp.com/send?phone=55${phone}&text=${encodeURIComponent(texto)}`, '_blank');
}

// TOQUE NO BANNER - DEVOLU√á√ÉO
(function() {
    function attachTapEvent() {
        const banner = document.getElementById('fiadoBanner');
        if (!banner) return;
        banner.addEventListener('click', abrirModalDevolucao);
    }
    document.addEventListener('DOMContentLoaded', attachTapEvent);
    setTimeout(attachTapEvent, 1000);
})();

async function abrirModalDevolucao() {
    const { data } = await sb.from("clients").select("*").order("name");
    const clientes = (data || []).filter(c => c.debt > 0);
    const list = document.getElementById('devolucaoList');
    if (!clientes.length) {
        list.innerHTML = '<div style="text-align:center;color:#888;padding:24px;">Nenhum cliente com d√©bito no momento.</div>';
    } else {
        list.innerHTML = clientes.map(c => `
            <div style="background:#f9f9f9; border-radius:16px; padding:14px; border:1px solid #eee;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                    <div>
                        <div style="font-weight:800; font-size:15px; color:#1a1a2e;">${c.name}</div>
                        <div style="font-size:12px; color:#888;">${c.phone}</div>
                    </div>
                    <div style="text-align:right;">
                        <div style="font-size:13px; color:#e74c3c; font-weight:700;">D√©bito: R$ ${c.debt.toFixed(2).replace('.', ',')}</div>
                    </div>
                </div>
                <div style="display:flex; gap:8px; align-items:center;">
                    <div style="position:relative; flex:1; display:flex; align-items:center;">
                        <span style="position:absolute; left:12px; font-weight:bold; color:#555; font-size:13px;">R$</span>
                        <input type="number" id="dev_${c.phone}" class="input-text" placeholder="0,00" min="0" step="0.01" style="padding-left:40px; margin:0; font-size:15px;">
                    </div>
                    <button onclick="executarDevolucao('${c.phone}', '${c.name.replace(/'/g,"\\'")}', ${c.debt})" class="btn btn-blue" style="white-space:nowrap; padding:12px 16px;">üí∏ Devolver</button>
                </div>
            </div>`).join('');
    }
    document.getElementById('modalDevolucao').style.display = 'flex';
}

async function executarDevolucao(phone, name, debtAtual) {
    const input = document.getElementById('dev_' + phone);
    const val = parseFloat(input.value);
    if (!val || val <= 0) {
        showToast({ type: 'confirm', title: '‚ö†Ô∏è Aten√ß√£o', body: 'Digite um valor de devolu√ß√£o v√°lido.' });
        return;
    }
    const novoSaldo = debtAtual - val;
    await sb.from("clients").update({ debt: novoSaldo }).eq("phone", phone);
    await sb.from("payments").insert({
        client_name: name,
        client_phone: phone,
        amount: val,
        saldo_anterior: debtAtual,
        saldo_posterior: novoSaldo,
        tipo: "devolucao"
    });
    input.value = '';
    document.getElementById('modalDevolucao').style.display = 'none';
    loadAdminClients();
    showToast({
        type: 'success',
        title: `üí∞ Devolu√ß√£o de R$ ${val.toFixed(2).replace('.', ',')} registrada!`,
        body: `${name} agora tem ${novoSaldo > 0 ? 'd√©bito de R$ ' + novoSaldo.toFixed(2).replace('.', ',') : novoSaldo < 0 ? 'cr√©dito de R$ ' + Math.abs(novoSaldo).toFixed(2).replace('.', ',') : 'saldo zerado ‚úÖ'}.`,
        duration: 5000
    });
}

// PEDIDOS
const ordersMap = {};

// Classifica√ß√£o por tipo de salgado ‚Äî detecta qualquer varia√ß√£o de nome
function abreviarNome(nome) {
    const n = nome.toLowerCase().trim()
        .replace(/\.+/g, '')   // remove pontos: "cox. frango" -> "cox frango"
        .replace(/\s+/g, ' '); // normaliza espa√ßos

    // Cox Frango: cont√©m "frango" ou ("cox" sem catupiry/charque/cat/cha)
    if (n.includes('frango') || n.includes('frang')) return 'cox';

    // Cox Catupiry: cont√©m "catupiry" ou "cat" (abrevia√ß√£o)
    if (n.includes('catupiry') || n.includes('catu')) return 'cat';

    // Cox Charque: cont√©m "charque" ou "cha" (abrevia√ß√£o)
    if (n.includes('charque') || n.includes('charg')) return 'cha';

    // Enroladinho: cont√©m "enrolad" ou "sal" (abrevia√ß√£o usada no sistema)
    if (n.includes('enrolad') || n.startsWith('sal')) return 'sal';

    // Queijo / R. Queijo: cont√©m "queijo" ou "quei"
    if (n.includes('queijo') || n.includes('quei') || n.startsWith('r.') || n.startsWith('r ')) return 'que';

    // Cox gen√©rica (sem tipo especificado) ‚Äî conta como cox
    if (n.includes('cox') || n.includes('coxinha')) return 'cox';

    // N√£o identificado ‚Äî retorna as 3 primeiras letras para debug
    return n.substring(0, 3);
}

async function loadOrderSummary() {
    const grid = document.getElementById('orderSummaryGrid');
    if (!grid) return;

    // Janela: das 12h de hoje at√© 5h do dia seguinte
    const now = new Date();
    const start = new Date(now);
    start.setHours(12, 0, 0, 0);
    // Se agora for antes das 12h, volta para 12h do dia anterior
    if (now.getHours() < 12) {
        start.setDate(start.getDate() - 1);
    }
    const end = new Date(start);
    end.setDate(end.getDate() + 1);
    end.setHours(5, 0, 0, 0);

    const { data } = await sb.from("orders")
        .select("items")
        .gte("created_at", start.toISOString())
        .lte("created_at", end.toISOString());

    const contagem = {};
    let totalGeral = 0;

    (data || []).forEach(o => {
        const linhas = (o.items || '').replace(/‚úÖ /g, '').split('\n').filter(Boolean);
        linhas.forEach(linha => {
            // Formato esperado: "2x Coxinha de Frango" ou "Coxinha de Frango"
            const match = linha.match(/^(\d+)[xX]\s*(.+)$/);
            if (match) {
                const qtd = parseInt(match[1]);
                const nome = abreviarNome(match[2]);
                contagem[nome] = (contagem[nome] || 0) + qtd;
                totalGeral += qtd;
            } else {
                // Sem quantidade, conta como 1
                const nome = abreviarNome(linha);
                contagem[nome] = (contagem[nome] || 0) + 1;
                totalGeral += 1;
            }
        });
    });

    renderSummaryGrid(contagem);
}

function renderSummaryGrid(contagem) {
    const grid = document.getElementById('orderSummaryGrid');
    if (!grid) return;
    // Ordem fixa: cox, cat, cha, sal, que ‚Äî sempre exibe todos mesmo com zero
    const ordem = ['cox', 'cat', 'cha', 'sal', 'que'];
    const cores = { cox:'#f39c12', cat:'#e74c3c', cha:'#8e44ad', sal:'#27ae60', que:'#3498db' };
    grid.innerHTML = ordem.map(nome => {
        const qtd = contagem[nome] || 0;
        const cor = cores[nome];
        const opacidade = qtd === 0 ? '0.35' : '1';
        return `<div style="background:rgba(255,255,255,0.08); border-radius:10px; padding:7px 0; display:flex; flex-direction:column; align-items:center; gap:2px; border-bottom:3px solid ${cor}; opacity:${opacidade}; flex:1;">
            <span style="font-size:20px; font-weight:900; color:${cor}; line-height:1;">${qtd}</span>
            <span style="font-size:10px; text-transform:uppercase; letter-spacing:0.5px; opacity:0.75;">${nome}</span>
        </div>`;
    }).join('');
}

// --- Dados do per√≠odo para o modal ---
let _summaryOrders = []; // pedidos do per√≠odo completo

// Hold 3s no cabe√ßalho
let _holdTimer = null;
let _holdAnimFrame = null;
let _holdStart = null;
const HOLD_MS = 3000;

function initSummaryHold() {
    const box = document.getElementById('orderSummaryBox');
    const bar = document.getElementById('summaryHoldBar');
    if (!box) return;

    function startHold(e) {
        _holdStart = Date.now();
        bar.style.transition = 'none';
        bar.style.width = '0%';
        bar.style.background = '#f1c40f';

        function animate() {
            const elapsed = Date.now() - _holdStart;
            const pct = Math.min(100, (elapsed / HOLD_MS) * 100);
            bar.style.width = pct + '%';
            if (pct < 100) {
                _holdAnimFrame = requestAnimationFrame(animate);
            } else {
                bar.style.width = '0%';
                abrirModalExcluir();
            }
        }
        _holdAnimFrame = requestAnimationFrame(animate);
    }

    function cancelHold() {
        cancelAnimationFrame(_holdAnimFrame);
        const bar = document.getElementById('summaryHoldBar');
        if (bar) { bar.style.transition = 'width 0.3s'; bar.style.width = '0%'; }
        _holdStart = null;
    }

    box.addEventListener('mousedown', startHold);
    box.addEventListener('touchstart', startHold, { passive: true });
    box.addEventListener('mouseup', cancelHold);
    box.addEventListener('mouseleave', cancelHold);
    box.addEventListener('touchend', cancelHold);
    box.addEventListener('touchcancel', cancelHold);
}

// Conjunto de phones exclu√≠dos (persistente na sess√£o)
let _excluidos = new Set();

async function abrirModalExcluir() {
    const modal = document.getElementById('modalExcluirClientes');
    const list = document.getElementById('excluirClientesList');
    modal.style.display = 'flex';
    list.innerHTML = '<div style="text-align:center;color:#888;padding:20px;">Carregando...</div>';

    // Busca pedidos do per√≠odo
    const now = new Date();
    const start = new Date(now);
    start.setHours(12, 0, 0, 0);
    if (now.getHours() < 12) start.setDate(start.getDate() - 1);
    const end = new Date(start);
    end.setDate(end.getDate() + 1);
    end.setHours(5, 0, 0, 0);

    const { data } = await sb.from("orders")
        .select("customer_name, customer_phone, items")
        .gte("created_at", start.toISOString())
        .lte("created_at", end.toISOString());

    _summaryOrders = data || [];

    // Agrupa por cliente
    const clientes = {};
    _summaryOrders.forEach(o => {
        const key = o.customer_phone || o.customer_name;
        if (!clientes[key]) clientes[key] = { name: o.customer_name, phone: key, pedidos: [] };
        clientes[key].pedidos.push(o.items || '');
    });

    if (Object.keys(clientes).length === 0) {
        list.innerHTML = '<div style="text-align:center;color:#bbb;padding:20px;">Nenhum cliente no per√≠odo</div>';
        return;
    }

    list.innerHTML = Object.values(clientes).map(c => {
        const checked = _excluidos.has(c.phone) ? 'checked' : '';
        const resumo = c.pedidos.map(p => p.replace(/‚úÖ /g,'').replace(/\n/g,', ').trim()).join(' | ');
        return `<label style="display:flex; align-items:center; gap:12px; background:#f9f9f9; border-radius:14px; padding:12px 14px; cursor:pointer; border:2px solid ${_excluidos.has(c.phone) ? '#e74c3c' : '#eee'};" id="label_${c.phone.replace(/\D/g,'')}">
            <input type="checkbox" ${checked} onchange="toggleExclusao('${c.phone}')" style="width:20px; height:20px; accent-color:#e74c3c; cursor:pointer; flex-shrink:0;">
            <div style="flex:1; min-width:0;">
                <div style="font-weight:800; font-size:14px; color:#222;">${c.name}</div>
                <div style="font-size:11px; color:#999; margin-top:2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${resumo}</div>
            </div>
        </label>`;
    }).join('');
}

function toggleExclusao(phone) {
    const labelId = 'label_' + phone.replace(/\D/g,'');
    const label = document.getElementById(labelId);
    if (_excluidos.has(phone)) {
        _excluidos.delete(phone);
        if (label) label.style.border = '2px solid #eee';
    } else {
        _excluidos.add(phone);
        if (label) label.style.border = '2px solid #e74c3c';
    }
}

function fecharModalExcluir() {
    document.getElementById('modalExcluirClientes').style.display = 'none';
}

async function aplicarExclusoes() {
    fecharModalExcluir();
    // Recalcula contagem excluindo clientes marcados
    const now = new Date();
    const start = new Date(now);
    start.setHours(12, 0, 0, 0);
    if (now.getHours() < 12) start.setDate(start.getDate() - 1);
    const end = new Date(start);
    end.setDate(end.getDate() + 1);
    end.setHours(5, 0, 0, 0);

    const { data } = await sb.from("orders")
        .select("customer_phone, items")
        .gte("created_at", start.toISOString())
        .lte("created_at", end.toISOString());

    const contagem = {};
    (data || []).forEach(o => {
        const key = o.customer_phone;
        if (_excluidos.has(key)) return; // pula exclu√≠dos
        const linhas = (o.items || '').replace(/‚úÖ /g, '').split('\n').filter(Boolean);
        linhas.forEach(linha => {
            const match = linha.match(/^(\d+)[xX]\s*(.+)$/);
            if (match) {
                const qtd = parseInt(match[1]);
                const nome = abreviarNome(match[2]);
                contagem[nome] = (contagem[nome] || 0) + qtd;
            } else {
                const nome = abreviarNome(linha);
                contagem[nome] = (contagem[nome] || 0) + 1;
            }
        });
    });

    renderSummaryGrid(contagem);
}

async function loadOrders() {
    loadOrderSummary();
    const list = document.getElementById('orderList');
    list.innerHTML = '<div style="text-align:center;color:#888;">Carregando...</div>';
    const { data } = await sb.from("orders").select("*").order("created_at", { ascending: false }).limit(50);
    if (!data || data.length === 0) { list.innerHTML = '<div style="text-align:center;color:#888;padding:20px;">Sem pedidos</div>'; return; }
    data.forEach(o => { ordersMap[o.id] = o; });
    list.innerHTML = data.map(o => buildOrderCard(o)).join('');
}

function buildOrderCard(o) {
    const isFiado = o.payment_method === 'FIADO';
    const valorColor = isFiado ? '#e74c3c' : '#27ae60';
    const badgeClass = isFiado ? 'badge-fiado' : 'badge-pago';
    const badgeLabel = isFiado ? '‚è≥ PAGAR DEPOIS' : 'ü§ù PAGAR NA ENTREGA';

    // Format time: "hoje √†s 19:04" or date
    const dt = new Date(o.created_at);
    const now = new Date();
    const isToday = dt.toDateString() === now.toDateString();
    const timeStr = isToday
        ? 'hoje √†s ' + dt.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })
        : dt.toLocaleDateString('pt-BR', { day:'2-digit', month:'2-digit' }) + ' √†s ' + dt.toLocaleTimeString('pt-BR', { hour:'2-digit', minute:'2-digit' });

    // Items: clean and list
    const itemLines = (o.items || '').replace(/‚úÖ /g, '').split('\n').filter(Boolean);
    const itemsHTML = itemLines.map(it => `<div>‚Ä¢ ${it}</div>`).join('');

    const btnFiado = !isFiado ? `<button class="order-fiado-btn" onclick="mudarParaFiado('${o.id}')">üìù Mudar para Pagar Depois</button>` : '';

    return `
    <div class="order-wrap" id="wrap_${o.id}">
        <div id="order_${o.id}" class="order-card">
            <div class="order-card-header">
                <div>
                    <div class="order-card-name">${o.customer_name}</div>
                    <div class="order-card-phone">${o.customer_phone || ''}</div>
                </div>
                <div style="text-align:right;">
                    <div class="order-card-time">${timeStr}</div>
                    <span class="order-card-badge ${badgeClass}">${badgeLabel}</span>
                </div>
            </div>
            <div class="order-card-items">${itemsHTML}</div>
            <div class="order-card-footer">
                <span class="order-card-valor" style="color:${valorColor};">R$ ${Number(o.total).toFixed(2).replace('.', ',')}</span>
            </div>
            ${btnFiado}
        </div>
    </div>`;
}

async function deletarPedido(orderId) {
    await sb.from("orders").delete().eq("id", orderId);
    delete ordersMap[orderId];
}

function mudarParaFiado(orderId) {
    const o = ordersMap[orderId];
    if (!o) return;
    showToast({
        type: 'confirm',
        title: `üìù Mudar para Pagar Depois?`,
        body: `Cliente: ${o.customer_name}\nValor: R$ ${Number(o.total).toFixed(2).replace('.', ',')}\nPagamento atual: ${o.payment_method}\n\nO valor ser√° lan√ßado no pagar depois do cliente.`,
        actions: [
            { label: 'Cancelar', bg: '#f0f0f0', color: '#555', fn: 'closeToast()' },
            { label: 'üìù Confirmar', bg: '#e67e22', color: 'white', fn: `executarMudarParaFiado('${orderId}')` }
        ],
        duration: 8000
    });
}

async function executarMudarParaFiado(orderId) {
    closeToast();
    const o = ordersMap[orderId];
    if (!o) return;

    // Atualiza o pedido para FIADO
    await sb.from("orders").update({ payment_method: 'FIADO' }).eq("id", orderId);

    // Lan√ßa o valor no fiado do cliente
    const { data: c } = await sb.from("clients").select("debt").eq("phone", o.customer_phone).single();
    if (c) {
        const novaDiv = (c.debt || 0) + Number(o.total);
        await sb.from("clients").update({ debt: novaDiv }).eq("phone", o.customer_phone);
    }

    // Atualiza o mapa local
    ordersMap[orderId] = { ...o, payment_method: 'FIADO' };

    // Atualiza o card visualmente sem recarregar tudo
    const card = document.getElementById('order_' + orderId);
    if (card) {
        card.style.borderLeftColor = 'var(--danger)';
        const strongs = card.querySelectorAll('strong');
        const lastStrong = strongs[strongs.length - 1];
        if (lastStrong) { lastStrong.style.color = 'var(--danger)'; lastStrong.textContent = 'R$ ' + Number(o.total).toFixed(2) + ' - PAGAR DEPOIS'; }
        const btn = card.querySelector('button');
        if (btn) btn.remove();
    }

    updateFiadoHeader();
    showToast({ type: 'success', title: '‚úÖ Alterado para Pagar Depois!', body: `R$ ${Number(o.total).toFixed(2).replace('.', ',')} lan√ßado no pagar depois de ${o.customer_name}.`, duration: 5000 });
}

async function clearAllOrders() {
    showToast({
        type: 'confirm',
        title: '‚ö†Ô∏è Apagar TODOS os pedidos?',
        body: 'Esta a√ß√£o n√£o pode ser desfeita! Todos os registros de pedidos ser√£o removidos.',
        actions: [
            { label: 'Cancelar', bg: '#f0f0f0', color: '#555', fn: 'closeToast()' },
            { label: 'üóëÔ∏è Apagar Tudo', bg: 'var(--danger)', color: 'white', fn: 'executarClearOrders()' }
        ],
        duration: 8000
    });
}
async function executarClearOrders() {
    closeToast();
    await sb.from("orders").delete().gte("id", "00000000-0000-0000-0000-000000000000");
    loadOrders();
    showToast({ type: 'success', title: '‚úÖ Pedidos apagados!', body: 'Todos os pedidos foram removidos.', duration: 4000 });
}

// MENSAGENS
async function loadTemplates() {
    const { data } = await sb.from("config").select("*");
    if (data) {
        const msgCfg = data.find(x => x.key === "msg_template");
        const cobrCfg = data.find(x => x.key === "msg_cobranca");
        const compCfg = data.find(x => x.key === "msg_comprovante");
        const extCfg  = data.find(x => x.key === "msg_extrato");
        if (msgCfg) msgTemplate = msgCfg.value;
        if (cobrCfg) msgCobranca = cobrCfg.value;
        if (compCfg) msgComprovante = compCfg.value;
        if (extCfg)  msgExtrato = extCfg.value;
    }
}

async function saveMsgTemplates() {
    msgTemplate = document.getElementById('editTemplate').value;
    msgCobranca = document.getElementById('editCobrancaTemplate').value;
    msgComprovante = document.getElementById('editComprovanteTemplate').value;
    msgExtrato = document.getElementById('editExtratoTemplate').value;
    await sb.from("config").upsert({ key: "msg_template", value: msgTemplate });
    await sb.from("config").upsert({ key: "msg_cobranca", value: msgCobranca });
    await sb.from("config").upsert({ key: "msg_comprovante", value: msgComprovante });
    await sb.from("config").upsert({ key: "msg_extrato", value: msgExtrato });
    showToast({ type: 'success', title: '‚úÖ Templates salvos!', body: 'Os templates foram atualizados com sucesso.', duration: 5000 });
}
// ===== REFAZER PEDIDOS =====
let refazerSelecionados = {};
let refazerBloqueados = JSON.parse(localStorage.getItem('refazer_bloqueados') || '[]');

function toggleBloqueioRefazer(phone, event) {
    event.stopPropagation();
    if (refazerBloqueados.includes(phone)) {
        refazerBloqueados = refazerBloqueados.filter(p => p !== phone);
    } else {
        refazerBloqueados.push(phone);
    }
    localStorage.setItem('refazer_bloqueados', JSON.stringify(refazerBloqueados));
    loadRefazerPedidos();
}
let autoRefazerTimer = null;

// ---- Persist√™ncia das sele√ß√µes ----
function salvarSelecoes() {
    localStorage.setItem('refazer_selecionados', JSON.stringify(refazerSelecionados));
}
function carregarSelecoes() {
    try { return JSON.parse(localStorage.getItem('refazer_selecionados') || '{}'); } catch(e) { return {}; }
}

// ---- Toggle autom√°tico ----
function toggleAutoRefazer(ativo) {
    localStorage.setItem('autoRefazer_ativo', ativo ? '1' : '0');
    atualizarBannerAgendamento();
    if (ativo) {
        agendarAutoRefazer();
    } else {
        if (autoRefazerTimer) { clearTimeout(autoRefazerTimer); autoRefazerTimer = null; }
    }
}

function atualizarBannerAgendamento() {
    const ativo = localStorage.getItem('autoRefazer_ativo') === '1';
    const toggle = document.getElementById('autoRefazerToggle');
    const status = document.getElementById('agendamentoStatus');
    const info = document.getElementById('agendamentoInfo');
    const ultimo = document.getElementById('agendamentoUltimo');
    if (toggle) toggle.checked = ativo;
    const ultimaExec = localStorage.getItem('autoRefazer_ultimaExec');
    const temHistorico = JSON.parse(localStorage.getItem('autoRefazer_historico') || '[]').length > 0;
    if (ultimaExec) {
        ultimo.innerHTML = `‚è±Ô∏è √öltima execu√ß√£o: ${ultimaExec} &nbsp;<button onclick="verHistoricoExecucoes()" style="background:rgba(255,255,255,0.2);border:none;border-radius:8px;padding:3px 8px;color:white;font-size:11px;cursor:pointer;">üìã Ver hist√≥rico</button>`;
        ultimo.style.display = 'block';
    } else if (temHistorico) {
        ultimo.innerHTML = `<button onclick="verHistoricoExecucoes()" style="background:rgba(255,255,255,0.2);border:none;border-radius:8px;padding:3px 8px;color:white;font-size:11px;cursor:pointer;">üìã Ver hist√≥rico</button>`;
        ultimo.style.display = 'block';
    }
    if (ativo) {
        const agora = new Date();
        const proximo6h = new Date(agora);
        proximo6h.setHours(6, 0, 0, 0);
        if (agora >= proximo6h) proximo6h.setDate(proximo6h.getDate() + 1);
        const diff = proximo6h - agora;
        const h = Math.floor(diff / 3600000);
        const m = Math.floor((diff % 3600000) / 60000);
        status.textContent = `‚úÖ Ativado ¬∑ Pr√≥ximo disparo em ${h}h ${m}min`;
        info.style.display = 'block';
    } else {
        status.textContent = '‚è∏Ô∏è Desativado ¬∑ Ative para lan√ßar pedidos automaticamente √†s 6h';
        info.style.display = 'none';
    }
}

function agendarAutoRefazer() {
    if (autoRefazerTimer) clearTimeout(autoRefazerTimer);
    const agora = new Date();
    const proximo4h = new Date(agora);
    proximo4h.setHours(6, 0, 0, 0);
    if (agora >= proximo4h) proximo4h.setDate(proximo4h.getDate() + 1);
    const msAte4h = proximo4h - agora;
    autoRefazerTimer = setTimeout(async () => {
        await executarAutoRefazer();
        // Reagenda para o pr√≥ximo dia
        if (localStorage.getItem('autoRefazer_ativo') === '1') {
            agendarAutoRefazer();
        }
    }, msAte4h);
}

async function executarAutoRefazer() {
    const sel = carregarSelecoes();
    const lista = Object.values(sel);
    if (lista.length === 0) return;

    // Quebra da regra: pedido feito ap√≥s as 12h do dia anterior
    const ontem12h = new Date();
    ontem12h.setDate(ontem12h.getDate() - 1);
    ontem12h.setHours(12, 0, 0, 0);

    const lancados = [];
    const pulados = [];

    const bloqueados = JSON.parse(localStorage.getItem('refazer_bloqueados') || '[]');

    for (const s of lista) {
        // Pula clientes bloqueados do autom√°tico
        if (bloqueados.includes(s.phone)) {
            pulados.push(s.name + ' (bloqueado)');
            continue;
        }

        const { data: pedidoRecente } = await sb.from("orders")
            .select("id")
            .eq("customer_phone", s.phone)
            .gte("created_at", ontem12h.toISOString())
            .limit(1);

        if (pedidoRecente && pedidoRecente.length > 0) {
            pulados.push(s.name);
            continue;
        }

        // Busca o pedido SALVO (‚≠ê) e o saldo do cliente
        const { data: c } = await sb.from("clients")
            .select("debt, saved_order, saved_order_total")
            .eq("phone", s.phone).single();
        if (!c) continue;

        if (!c.saved_order || !c.saved_order.trim()) {
            pulados.push(s.name + ' (sem pedido salvo)');
            continue;
        }

        const totalParaUsar = Number(c.saved_order_total) || Number(s.total) || 0;
        await sb.from("clients").update({ debt: (c.debt || 0) + totalParaUsar }).eq("phone", s.phone);
        const { data: novoPedido } = await sb.from("orders").insert({
            customer_name: s.name,
            customer_phone: s.phone,
            total: totalParaUsar,
            payment_method: 'FIADO',
            items: c.saved_order
        }).select().single();
        lancados.push({ name: s.name, phone: s.phone, total: totalParaUsar, orderId: novoPedido ? novoPedido.id : null });
    }

    const agora = new Date();
    const agoraStr = agora.toLocaleString('pt-BR');
    localStorage.setItem('autoRefazer_ultimaExec', agoraStr);

    // Salva hist√≥rico de execu√ß√µes (m√°x 30)
    const historico = JSON.parse(localStorage.getItem('autoRefazer_historico') || '[]');
    historico.unshift({ data: agoraStr, lancados, pulados });
    if (historico.length > 30) historico.pop();
    localStorage.setItem('autoRefazer_historico', JSON.stringify(historico));

    // Salva badges dos pulados para exibir nos cards
    const badgesPulados = JSON.parse(localStorage.getItem('autoRefazer_pulados') || '{}');
    pulados.forEach(nome => {
        const found = Object.values(sel).find(x => x.name === nome);
        const phone = found ? found.phone : null;
        if (phone) badgesPulados[phone] = agoraStr;
    });
    localStorage.setItem('autoRefazer_pulados', JSON.stringify(badgesPulados));

    updateFiadoHeader();

    let body = '';
    if (lancados.length > 0) body += `‚úÖ Lan√ßados (${lancados.length}):\n${lancados.map(x => '‚Ä¢ ' + x.name).join('\n')}`;
    if (pulados.length > 0) body += `\n\n‚è≠Ô∏è Pulados (${pulados.length}):\n${pulados.map(n => '‚Ä¢ ' + n).join('\n')}`;
    if (lancados.length === 0) body = `Nenhum pedido lan√ßado.\nTodos j√° pediram ap√≥s as 12h de ontem.`;

    showToast({
        type: 'success',
        title: `ü§ñ Autom√°tico executado √†s 06:00`,
        body: body.trim(),
        duration: 12000
    });
    atualizarBannerAgendamento();
}

// Inicializa o scheduler ao carregar a p√°gina
(function initAutoRefazer() {
    if (localStorage.getItem('autoRefazer_ativo') === '1') {
        agendarAutoRefazer();
    }
})();

async function loadRefazerPedidos() {
    atualizarBannerAgendamento();
    const list = document.getElementById('refazerList');
    list.innerHTML = '<div style="text-align:center;color:#888;padding:20px;">Carregando...</div>';
    refazerSelecionados = carregarSelecoes(); // restaura sele√ß√µes salvas
    atualizarResumoRefazer();

    // Busca todos os clientes
    const { data: clients } = await sb.from("clients").select("*").order("name");
    if (!clients || clients.length === 0) {
        list.innerHTML = '<div style="text-align:center;color:#888;padding:20px;">Nenhum cliente</div>';
        return;
    }

    // Usa o pedido SALVO (‚≠ê) de cada cliente ‚Äî l√™ diretamente de clients.saved_order
    const cards = clients.map(c => {
        const temSalvo = c.saved_order && c.saved_order.trim();
        const lastOrder = temSalvo ? {
            total: c.saved_order_total || 0,
            items: c.saved_order,
            _isSaved: true
        } : null;
        return { client: c, lastOrder };
    });

    // Mostra TODOS os clientes, incluindo an√¥nimos (show_name === false)
    const cardsFiltrados = cards;

    // Pr√©-seleciona automaticamente clientes vis√≠veis (show_name === true) que ainda n√£o est√£o na sele√ß√£o
    cardsFiltrados.forEach(({ client: c, lastOrder: o }) => {
        if (o && c.show_name === true && !refazerSelecionados[c.phone]) {
            refazerSelecionados[c.phone] = { phone: c.phone, name: c.name, total: o.total, items: o.items, show_name: true };
        }
    });
    salvarSelecoes();
    atualizarResumoRefazer();

    if (cardsFiltrados.length === 0) {
        list.innerHTML = '<div style="text-align:center;color:#888;padding:30px;">Nenhum cliente para exibir.</div>';
        return;
    }

    list.innerHTML = cardsFiltrados.map(({ client: c, lastOrder: o }) => {
        const nomeExibido = c.show_name === false ? 'üîí An√¥nimo' : c.name;
        if (!o) return `
            <div style="background:white;border:1px solid #eee;border-radius:16px;padding:14px;margin-bottom:10px;opacity:0.5;display:flex;justify-content:space-between;align-items:center;">
                <div><strong>${nomeExibido}</strong><br><small style="color:#aaa;">‚≠ê Nenhum pedido salvo</small></div>
            </div>`;

        const valor = Number(o.total).toFixed(2).replace('.', ',');
        const itens = (o.items || '').replace(/‚úÖ /g,'').replace(/\n/g,' | ').trim();
        const isSel = !!refazerSelecionados[c.phone];
        const badgesPulados = JSON.parse(localStorage.getItem('autoRefazer_pulados') || '{}');
        const foiPulado = badgesPulados[c.phone];
        const badgePulado = foiPulado
            ? `<div style="margin-top:6px;background:#fff3cd;border:1px solid #f39c12;border-radius:8px;padding:4px 8px;font-size:11px;color:#b7770d;font-weight:700;">‚è≠Ô∏è Pulado em ${foiPulado} ¬∑ j√° pediu ap√≥s 12h de ontem</div>`
            : '';

        const isBloqueado = refazerBloqueados.includes(c.phone);
        const badgeBloqueado = isBloqueado
            ? `<div style="margin-top:6px;background:#fdecea;border:1px solid #e74c3c;border-radius:8px;padding:4px 8px;font-size:11px;color:#c0392b;font-weight:700;">üö´ Bloqueado do autom√°tico</div>`
            : '';

        return `
            <div id="card_refazer_${c.phone}" onclick="toggleRefazer('${c.phone}','${c.name.replace(/'/g,"\'")}',${o.total},'${o.items.replace(/'/g,"\'").replace(/\n/g,"\\n")}',${c.show_name === true})"
                style="background:${isSel?'#fdf6ff':'white'};border:2px solid ${isSel?'#8e44ad':'#eee'};border-radius:16px;padding:14px;margin-bottom:10px;cursor:pointer;transition:0.2s;${isBloqueado?'opacity:0.6;':''}">
                <div style="display:flex;justify-content:space-between;align-items:center;">
                    <div>
        <strong style="font-size:15px;">${nomeExibido}</strong>
                        <div style="font-size:12px;color:#888;margin-top:2px;">${itens}</div>
                        <div style="font-size:12px;color:#8e44ad;margin-top:2px;font-weight:700;">‚≠ê Pedido salvo</div>
                    </div>
                    <div style="text-align:right;display:flex;flex-direction:column;align-items:flex-end;gap:6px;">
                        <button onclick="toggleBloqueioRefazer('${c.phone}', event)" style="background:${isBloqueado?'#e74c3c':'#eee'};border:none;border-radius:10px;padding:4px 8px;cursor:pointer;font-size:12px;color:${isBloqueado?'white':'#888'};" title="${isBloqueado?'Desbloquear autom√°tico':'Bloquear autom√°tico'}">üö´</button>
                        <div style="font-size:18px;font-weight:900;color:#8e44ad;">R$ ${valor}</div>
                        <div id="check_${c.phone}" style="width:26px;height:26px;border:2px solid ${isSel?'#8e44ad':'#ddd'};border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:14px;background:${isSel?'#8e44ad':''};color:${isSel?'white':''}">${isSel?'‚úì':''}</div>
                    </div>
                </div>
                ${badgePulado}
                ${badgeBloqueado}
            </div>`;
    }).join('');
}

function verHistoricoExecucoes() {
    const modal = document.getElementById('modalHistoricoExec');
    const list = document.getElementById('historicoExecList');
    modal.style.display = 'flex';
    renderHistoricoExecucoes();
}

function renderHistoricoExecucoes() {
    const list = document.getElementById('historicoExecList');
    const historico = JSON.parse(localStorage.getItem('autoRefazer_historico') || '[]');
    if (historico.length === 0) {
        list.innerHTML = '<div style="text-align:center;color:#aaa;padding:30px;">Nenhuma execu√ß√£o registrada ainda.</div>';
        return;
    }
    list.innerHTML = historico.map((h, i) => {
        const lancHTML = h.lancados.length > 0
            ? `<div style="margin-top:8px;"><span style="color:#27ae60;font-weight:700;">‚úÖ Lan√ßados (${h.lancados.length}):</span>${h.lancados.map(x => {
                const name = typeof x === 'object' ? x.name : x;
                const total = typeof x === 'object' ? Number(x.total).toFixed(2).replace('.', ',') : '?';
                const orderId = typeof x === 'object' ? x.orderId : null;
                const phone = typeof x === 'object' ? x.phone : null;
                const cancelado = typeof x === 'object' && x.cancelado;
                return `<div style="display:flex;justify-content:space-between;align-items:center;margin-top:6px;background:#f9f9f9;border-radius:10px;padding:6px 10px;">
                    <span style="font-size:13px;${cancelado?'text-decoration:line-through;color:#aaa;':''}">‚Ä¢ ${name} ¬∑ R$ ${total}</span>
                    ${cancelado
                        ? `<span style="font-size:11px;color:#e74c3c;font-weight:700;">Cancelado</span>`
                        : orderId
                            ? `<button onclick="cancelarPedidoAutoRefazer(${i},'${orderId}','${phone}',${x.total},'${name}')" style="background:#fff0f0;border:1.5px solid #e74c3c;color:#e74c3c;border-radius:8px;padding:4px 10px;font-size:11px;font-weight:700;cursor:pointer;">üóëÔ∏è Cancelar</button>`
                            : `<span style="font-size:11px;color:#aaa;">sem id</span>`
                    }
                </div>`;
            }).join('')}</div>`
            : '';
        const pulHTML = h.pulados.length > 0
            ? `<div style="margin-top:6px;"><span style="color:#f39c12;font-weight:700;">‚è≠Ô∏è Pulados (${h.pulados.length}):</span><br>${h.pulados.map(n => `<span style="font-size:12px;">‚Ä¢ ${n}</span>`).join('<br>')}</div>`
            : '';
        const nenhum = h.lancados.length === 0 && h.pulados.length === 0
            ? '<div style="font-size:12px;color:#aaa;margin-top:4px;">Nenhum cliente selecionado.</div>' : '';
        return `
        <div style="background:#fafafa;border:1px solid #eee;border-radius:14px;padding:14px;margin-bottom:10px;border-left:4px solid #8e44ad;">
            <div style="font-weight:800;font-size:13px;color:#555;">ü§ñ Execu√ß√£o #${historico.length - i} ¬∑ ${h.data}</div>
            ${lancHTML}${pulHTML}${nenhum}
        </div>`;
    }).join('');
}

function cancelarPedidoAutoRefazer(execIndex, orderId, phone, total, name) {
    showToast({
        type: 'confirm',
        title: `üóëÔ∏è Cancelar pedido de ${name}?`,
        body: `R$ ${Number(total).toFixed(2).replace('.', ',')} ser√° estornado do pagar depois.`,
        actions: [
            { label: 'N√£o', bg: '#f0f0f0', color: '#555', fn: 'closeToast()' },
            { label: 'üóëÔ∏è Confirmar', bg: 'var(--danger)', color: 'white', fn: `executarCancelamentoAutoRefazer(${execIndex},'${orderId}','${phone}',${total},'${name}')` }
        ],
        duration: 8000
    });
}

async function executarCancelamentoAutoRefazer(execIndex, orderId, phone, total, name) {
    closeToast();

    // Remove o pedido
    await sb.from("orders").delete().eq("id", orderId);

    // Estorna do fiado
    const { data: c } = await sb.from("clients").select("debt").eq("phone", phone).single();
    if (c) {
        await sb.from("clients").update({ debt: (c.debt || 0) - Number(total) }).eq("phone", phone);
    }

    // Remove do hist√≥rico local
    const historico = JSON.parse(localStorage.getItem('autoRefazer_historico') || '[]');
    if (historico[execIndex]) {
        historico[execIndex].lancados = historico[execIndex].lancados.filter(x => !(typeof x === 'object' && x.orderId === orderId));
        localStorage.setItem('autoRefazer_historico', JSON.stringify(historico));
    }

    updateFiadoHeader();
    renderHistoricoExecucoes();
    showToast({ type: 'success', title: '‚úÖ Cancelado!', body: `R$ ${Number(total).toFixed(2).replace('.', ',')} estornado do pagar depois de ${name}.`, duration: 5000 });
}

function toggleRefazer(phone, name, total, items, showName = false) {
    const card = document.getElementById('card_refazer_' + phone);
    const check = document.getElementById('check_' + phone);
    if (refazerSelecionados[phone]) {
        delete refazerSelecionados[phone];
        card.style.border = '2px solid #eee';
        card.style.background = 'white';
        check.textContent = '';
        check.style.borderColor = '#ddd';
        check.style.background = '';
        check.style.color = '';
    } else {
        refazerSelecionados[phone] = { phone, name, total, items, show_name: showName };
        card.style.border = '2px solid #8e44ad';
        card.style.background = '#fdf6ff';
        check.textContent = '‚úì';
        check.style.borderColor = '#8e44ad';
        check.style.background = '#8e44ad';
        check.style.color = 'white';
    }
    salvarSelecoes();
    atualizarResumoRefazer();
}

function atualizarResumoRefazer() {
    const resumo = document.getElementById('refazerResumo');
    const sel = Object.values(refazerSelecionados);
    if (sel.length === 0) { resumo.style.display = 'none'; return; }
    const totalGeral = sel.reduce((s, x) => s + Number(x.total), 0);
    document.getElementById('refazerSelecionados').innerHTML =
        `<strong>${sel.length} cliente(s) selecionado(s)</strong> ¬∑ Total: <strong style="color:#8e44ad;">R$ ${totalGeral.toFixed(2).replace('.', ',')}</strong><br>` +
        sel.map(x => `‚Ä¢ ${x.show_name === false ? 'üîí An√¥nimo' : x.name}: R$ ${Number(x.total).toFixed(2).replace('.', ',')}`).join('<br>');
    resumo.style.display = 'block';
}

async function confirmarTodosRefazer() {
    const sel = Object.values(refazerSelecionados);
    if (sel.length === 0) return;

    const totalGeral = sel.reduce((s, x) => s + Number(x.total), 0).toFixed(2).replace('.', ',');
    const nomes = sel.map(x => `‚Ä¢ ${x.show_name === false ? 'üîí An√¥nimo' : x.name}: R$ ${Number(x.total).toFixed(2).replace('.',',')}`).join('\n');

    showToast({
        type: 'confirm',
        title: `üîÅ Lan√ßar Pagar Depois para ${sel.length} cliente(s)?`,
        body: `${nomes}\n\nTotal geral: R$ ${totalGeral}`,
        actions: [
            { label: 'Cancelar', bg: '#f0f0f0', color: '#555', fn: 'closeToast()' },
            { label: '‚úÖ Confirmar', bg: 'var(--success)', color: 'white', fn: 'executarTodosRefazer()' }
        ],
        duration: 8000
    });
}

async function executarTodosRefazer() {
    closeToast();
    const sel = Object.values(refazerSelecionados);
    const totalGeral = sel.reduce((s, x) => s + Number(x.total), 0).toFixed(2).replace('.', ',');

    for (const s of sel) {
        const { data: c } = await sb.from("clients").select("debt").eq("phone", s.phone).single();
        await sb.from("clients").update({ debt: (c.debt || 0) + Number(s.total) }).eq("phone", s.phone);
        await sb.from("orders").insert({
            customer_name: s.name,
            customer_phone: s.phone,
            total: Number(s.total),
            payment_method: 'FIADO',
            items: s.items.replace(/\\n/g, '\n')
        });
    }

    refazerSelecionados = {};
    salvarSelecoes();
    loadRefazerPedidos();
    updateFiadoHeader();
    showToast({ type: 'success', title: `‚úÖ Pedidos lan√ßados!`, body: `${sel.length} pedido(s) adicionados no pagar depois.\nTotal: R$ ${totalGeral}`, duration: 8000 });
}

// ===== COMPRA NO NOME =====
let compraCart = {};
let compraPagamento = 'FIADO';
let compraClienteAtual = null;
let compraProdutos = [];

async function loadCompraTab() {
    compraCart = {};
    compraPagamento = 'FIADO';
    compraClienteAtual = null;
    document.getElementById('compraClienteInfo').style.display = 'none';
    document.getElementById('compraTotalLabel').textContent = 'R$ 0,00';

    // Load clients into select
    const { data: clients } = await sb.from("clients").select("*").order("name");
    const sel = document.getElementById('compraCliente');
    sel.innerHTML = '<option value="">-- Escolha o cliente --</option>' +
        (clients || []).map(c => `<option value="${c.phone}" data-name="${c.name}" data-debt="${c.debt}" data-fiado="${c.fiado}">${c.name}</option>`).join('');

    // Load products
    const { data: prods } = await sb.from("products").select("*").eq("available", true).order("created_at", { ascending: true });
    compraProdutos = prods || [];
    renderCompraProdList();
}

function onCompraClienteChange() {
    const sel = document.getElementById('compraCliente');
    const opt = sel.options[sel.selectedIndex];
    if (!opt.value) { compraClienteAtual = null; document.getElementById('compraClienteInfo').style.display = 'none'; return; }
    compraClienteAtual = { phone: opt.value, name: opt.dataset.name, debt: parseFloat(opt.dataset.debt), fiado: opt.dataset.fiado === 'true' };
    const infoEl = document.getElementById('compraClienteInfo');
    const debt = compraClienteAtual.debt;
    infoEl.innerHTML = `üìû ${opt.value} &nbsp;|&nbsp; ${debt > 0 ? '<span style="color:#e74c3c;">D√©bito: R$ ' + debt.toFixed(2) + '</span>' : debt < 0 ? '<span style="color:#3498db;">Cr√©dito: R$ ' + Math.abs(debt).toFixed(2) + '</span>' : '<span style="color:#27ae60;">Em dia ‚úÖ</span>'} &nbsp;|&nbsp; Pagar Depois: ${compraClienteAtual.fiado ? '‚úÖ' : '‚ùå'}`;
    infoEl.style.display = 'block';
}

function renderCompraProdList() {
    const list = document.getElementById('compraProdList');
    list.innerHTML = compraProdutos.map(p => `
        <div style="display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid #f0f0f0;">
            <div style="display:flex;align-items:center;gap:10px;flex:1;">
                ${p.image_url ? `<img src="${p.image_url}" style="width:40px;height:40px;border-radius:10px;object-fit:cover;">` : '<div style="width:40px;height:40px;border-radius:10px;background:#1a1a2e;display:flex;align-items:center;justify-content:center;font-size:20px;">ü•ü</div>'}
                <div><div style="font-weight:700;font-size:14px;">${p.name}</div><div style="color:var(--primary);font-size:13px;">R$ ${Number(p.price).toFixed(2)}</div></div>
            </div>
            <div style="display:flex;align-items:center;gap:8px;background:#f5f5f5;border-radius:20px;padding:4px 10px;">
                <button onclick="qtyCompra('${p.id}',-1)" style="width:26px;height:26px;border-radius:50%;border:none;background:var(--danger);color:white;font-size:16px;font-weight:bold;cursor:pointer;">‚àí</button>
                <span id="cqty_${p.id}" style="min-width:22px;text-align:center;font-weight:bold;font-size:15px;">${compraCart[p.id] || 0}</span>
                <button onclick="qtyCompra('${p.id}',1)" style="width:26px;height:26px;border-radius:50%;border:none;background:var(--success);color:white;font-size:16px;font-weight:bold;cursor:pointer;">+</button>
            </div>
        </div>`).join('');
    atualizarTotalCompra();
}

function qtyCompra(id, d) {
    compraCart[id] = (compraCart[id] || 0) + d;
    if (compraCart[id] <= 0) delete compraCart[id];
    const el = document.getElementById('cqty_' + id);
    if (el) el.textContent = compraCart[id] || 0;
    atualizarTotalCompra();
}

function atualizarTotalCompra() {
    let total = 0;
    for (let id in compraCart) {
        const p = compraProdutos.find(x => x.id == id);
        if (p) total += p.price * compraCart[id];
    }
    document.getElementById('compraTotalLabel').textContent = 'R$ ' + total.toFixed(2).replace('.', ',');
}

function selecionarPagamentoCompra(metodo) {
    compraPagamento = metodo;
    ['FIADO','PAGA NA ENTREGA'].forEach(m => {
        const el = document.getElementById('cpopt-' + m.replace(/ /g,'-'));
        if (el) el.style.borderColor = m === metodo ? 'var(--success)' : '#eee';
        if (el) el.style.background = m === metodo ? '#e8f5e9' : 'white';
        if (el) el.style.color = m === metodo ? 'var(--success)' : '#333';
    });
}

// NOTIFICATION SOUND
function playNotifSound() {
    try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const t = ctx.currentTime;
        // Two-tone notification ping (like phone)
        [0, 0.12].forEach((delay, i) => {
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.connect(gain); gain.connect(ctx.destination);
            osc.type = 'sine';
            osc.frequency.setValueAtTime(i === 0 ? 880 : 1100, t + delay);
            gain.gain.setValueAtTime(0, t + delay);
            gain.gain.linearRampToValueAtTime(0.35, t + delay + 0.02);
            gain.gain.exponentialRampToValueAtTime(0.001, t + delay + 0.18);
            osc.start(t + delay);
            osc.stop(t + delay + 0.2);
        });
    } catch(e) {}
}

// TOAST SYSTEM
let toastTimer = null;
let toastProgressEl = null;

function showToast({ type = 'success', title, body, actions = [], duration = 8000 }) {
    const container = document.getElementById('toastContainer');
    // Remove existing toast
    const existing = container.querySelector('.toast');
    if (existing) existing.remove();
    if (toastTimer) clearTimeout(toastTimer);

    const actionsHTML = actions.map(a =>
        `<button class="toast-btn" style="background:${a.bg};color:${a.color};" onclick="${a.fn}">${a.label}</button>`
    ).join('');

    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.innerHTML = `
        <div class="toast-app-row">
            <div class="toast-app-icon">üçó</div>
            <span class="toast-app-name">Rei da Coxinha</span>
            <span class="toast-time">agora</span>
        </div>
        <div class="toast-header">
            <span class="toast-title">${title}</span>
            <button class="toast-close" onclick="closeToast()">‚úï</button>
        </div>
        <div class="toast-body">${body}</div>
        ${actionsHTML ? `<div class="toast-actions">${actionsHTML}</div>` : ''}
        <div class="toast-bar"><div class="toast-progress" style="animation-duration:${duration}ms;"></div></div>
    `;
    container.appendChild(toast);
    requestAnimationFrame(() => { toast.classList.add('show'); });
    if (type === 'success') playNotifSound();

    toastTimer = setTimeout(closeToast, duration);
}

function closeToast() {
    if (toastTimer) { clearTimeout(toastTimer); toastTimer = null; }
    const toast = document.querySelector('.toast');
    if (toast) {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 400);
    }
}

async function confirmarCompra() {
    if (!compraClienteAtual) { showToast({ type:'confirm', title:'‚ö†Ô∏è Aten√ß√£o', body:'Selecione um cliente!' }); return; }
    if (Object.keys(compraCart).length === 0) { showToast({ type:'confirm', title:'‚ö†Ô∏è Aten√ß√£o', body:'Adicione pelo menos um produto!' }); return; }

    let total = 0; let pedidoTexto = ""; let pedidoHTML = "";
    for (let id in compraCart) {
        const p = compraProdutos.find(x => x.id == id);
        if (p) {
            pedidoTexto += `‚úÖ ${compraCart[id]}x ${p.name}\n`;
            pedidoHTML += `${compraCart[id]}x ${p.name}\n`;
            total += p.price * compraCart[id];
        }
    }

    // Mostrar toast de confirma√ß√£o
    showToast({
        type: 'confirm',
        title: `üõí Confirmar compra para ${compraClienteAtual.name}?`,
        body: `${pedidoHTML.trim()}\n\nüí∞ Total: R$ ${total.toFixed(2).replace('.', ',')}\nüí≥ Pagamento: ${compraPagamento}`,
        actions: [
            { label: 'Cancelar', bg: '#f0f0f0', color: '#555', fn: 'closeToast()' },
            { label: '‚úÖ Confirmar', bg: 'var(--success)', color: 'white', fn: `executarCompra(${total}, \`${pedidoTexto.replace(/`/g,"'")}\`)` }
        ],
        duration: 8000
    });
}

async function executarCompra(total, pedidoTexto) {
    closeToast();

    await sb.from("orders").insert({
        customer_name: compraClienteAtual.name,
        customer_phone: compraClienteAtual.phone,
        total: total,
        payment_method: compraPagamento,
        items: pedidoTexto
    });

    if (compraPagamento === 'FIADO') {
        const { data: c } = await sb.from("clients").select("debt").eq("phone", compraClienteAtual.phone).single();
        await sb.from("clients").update({ debt: (c.debt || 0) + total }).eq("phone", compraClienteAtual.phone);
    }

    showToast({ type: 'success', title: `‚úÖ Compra registrada!`, body: `Pedido de ${compraClienteAtual.name} salvo com sucesso.`, duration: 8000 });

    compraCart = {};
    renderCompraProdList();
    document.getElementById('compraCliente').value = '';
    document.getElementById('compraClienteInfo').style.display = 'none';
    compraClienteAtual = null;
    updateFiadoHeader();
}
// Mapa seguro para dados dos pedidos do hist√≥rico
const historicoMap = {};

async function loadHistoricoPagamentos() {
    const list = document.getElementById('pagamentosList');
    const contador = document.getElementById('pagamentosContador');
    const totalEl = document.getElementById('pagamentosTotalValor');

    list.innerHTML = '<div style="text-align:center;padding:30px;color:#999;">Carregando...</div>';

    const { data, error } = await sb
        .from("payments")
        .select("*")
        .order("created_at", { ascending: false })
        .limit(100);

    if (error || !data || data.length === 0) {
        list.innerHTML = '<div style="text-align:center;padding:40px;color:#bbb;font-size:15px;">üì≠ Nenhum pagamento registrado ainda.</div>';
        contador.textContent = '0 registros';
        totalEl.textContent = 'R$ 0,00';
        return;
    }

    contador.textContent = data.length + ' registro' + (data.length > 1 ? 's' : '');
    const total = data.reduce(function(s, p) { return s + Number(p.amount); }, 0);
    totalEl.textContent = 'R$ ' + total.toFixed(2).replace('.', ',');

    list.innerHTML = data.map(function(p) {
        const date = new Date(p.created_at);
        const dateStr = date.toLocaleDateString('pt-BR', { day:'2-digit', month:'2-digit', year:'numeric' });
        const timeStr = date.toLocaleTimeString('pt-BR', { hour:'2-digit', minute:'2-digit' });
        const saldoAntes = Number(p.saldo_anterior || 0).toFixed(2).replace('.', ',');
        const saldoDepois = Number(p.saldo_posterior || 0).toFixed(2).replace('.', ',');
        const saldoColor = Number(p.saldo_posterior) <= 0 ? '#27ae60' : '#e74c3c';
        const saldoLabel = Number(p.saldo_posterior) <= 0 ? '‚úÖ Quitado' : 'Restante: R$ ' + saldoDepois;
        const bgSaldo = Number(p.saldo_posterior) <= 0 ? '#d5f5e3' : '#fde8e8';

        return '<div style="background:white;border-radius:18px;padding:16px;margin-bottom:12px;box-shadow:0 2px 10px rgba(0,0,0,0.06);border-left:4px solid #2980b9;">' +
            '<div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:10px;">' +
                '<div>' +
                    '<div style="font-weight:800;font-size:15px;color:#222;">üë§ ' + p.client_name + '</div>' +
                    '<div style="font-size:12px;color:#999;margin-top:2px;">üìû ' + (p.client_phone || '‚Äî') + '</div>' +
                    '<div style="font-size:11px;color:#aaa;margin-top:2px;">üìÖ ' + dateStr + ' √†s ' + timeStr + '</div>' +
                '</div>' +
                '<div style="text-align:right;">' +
                    '<div style="font-size:22px;font-weight:900;color:#27ae60;">+ R$ ' + Number(p.amount).toFixed(2).replace('.', ',') + '</div>' +
                '</div>' +
            '</div>' +
            '<div style="display:flex;gap:8px;flex-wrap:wrap;">' +
                '<span style="background:#f0f0f0;color:#555;font-size:12px;font-weight:600;padding:4px 10px;border-radius:20px;">Antes: R$ ' + saldoAntes + '</span>' +
                '<span style="background:' + bgSaldo + ';color:' + saldoColor + ';font-size:12px;font-weight:700;padding:4px 10px;border-radius:20px;">' + saldoLabel + '</span>' +
            '</div>' +
        '</div>';
    }).join('');
}

let _historicoAllData = [];
let _historicoFiltroAtual = 'todos';
let _historicoBuscaAtual = '';
let _historicoPagina = 0;
const _HISTORICO_PAGE_SIZE = 50;

async function loadHistoricoFiado() {
    const list = document.getElementById('historicoList');
    const contador = document.getElementById('historicoContador');
    list.innerHTML = '<div style="text-align:center;padding:30px;color:#999;">Carregando...</div>';

    // Busca as √∫ltimas 50 compras do Supabase
    const { data: allData, error } = await sb
        .from("orders")
        .select("*")
        .order("created_at", { ascending: false })
        .limit(50);

    if (error || !allData || allData.length === 0) {
        list.innerHTML = '<div style="text-align:center;padding:40px;color:#bbb;font-size:15px;">üì≠ Nenhuma compra encontrada.</div>';
        contador.textContent = '0 registros';
        return;
    }

    allData.forEach(o => { historicoMap[o.id] = o; });
    _historicoAllData = allData;
    _historicoFiltroAtual = 'todos';
    _historicoBuscaAtual = '';
    _historicoPagina = 0;
    document.getElementById('historicoBusca').value = '';
    atualizarFiltrosHistorico('todos');
    renderHistorico();
}

function _getHistoricoFiltrado() {
    let dados = _historicoAllData;
    if (_historicoFiltroAtual === 'FIADO') {
        dados = dados.filter(o => (o.payment_method || '').toUpperCase() === 'FIADO');
    } else if (_historicoFiltroAtual === 'PAGO') {
        dados = dados.filter(o => (o.payment_method || '').toUpperCase() !== 'FIADO');
    }
    if (_historicoBuscaAtual.trim()) {
        const q = _historicoBuscaAtual.trim().toLowerCase();
        dados = dados.filter(o => (o.customer_name || '').toLowerCase().includes(q) || (o.customer_phone || '').includes(q));
    }
    return dados;
}

function filtrarHistorico(filtro) {
    _historicoFiltroAtual = filtro;
    _historicoPagina = 0;
    atualizarFiltrosHistorico(filtro);
    renderHistorico();
}

function buscarHistorico(valor) {
    _historicoBuscaAtual = valor;
    _historicoPagina = 0;
    renderHistorico();
}

function carregarMaisHistorico() {
    _historicoPagina++;
    renderHistorico(true);
}

function atualizarFiltrosHistorico(ativo) {
    const estilos = {
        'todos': { id: 'filtro-todos', cor: '#16a085' },
        'FIADO': { id: 'filtro-fiado', cor: '#e74c3c' },
        'PAGO':  { id: 'filtro-pago',  cor: '#27ae60' }
    };
    Object.entries(estilos).forEach(([key, { id, cor }]) => {
        const btn = document.getElementById(id);
        if (!btn) return;
        if (key === ativo) {
            btn.style.background = cor;
            btn.style.color = 'white';
            btn.style.borderColor = cor;
        } else {
            btn.style.background = 'white';
            btn.style.color = cor;
            btn.style.borderColor = cor;
        }
    });
}

function renderHistorico(append = false) {
    const list = document.getElementById('historicoList');
    const contador = document.getElementById('historicoContador');
    const loadMoreBtn = document.getElementById('historicoLoadMore');
    const dados = _getHistoricoFiltrado();

    if (!dados || dados.length === 0) {
        list.innerHTML = '<div style="text-align:center;padding:40px;color:#bbb;font-size:15px;">üì≠ Nenhuma compra encontrada.</div>';
        contador.textContent = '0 registros';
        loadMoreBtn.style.display = 'none';
        return;
    }

    const total = dados.length;
    const ate = (_historicoPagina + 1) * _HISTORICO_PAGE_SIZE;
    const paginados = dados.slice(0, ate);

    contador.textContent = `${paginados.length} de ${total}`;
    loadMoreBtn.style.display = ate < total ? 'block' : 'none';

    const html = paginados.map((o) => {
        const date = new Date(o.created_at);
        const dateStr = date.toLocaleDateString('pt-BR', { day:'2-digit', month:'2-digit', year:'numeric' });
        const timeStr = date.toLocaleTimeString('pt-BR', { hour:'2-digit', minute:'2-digit' });
        const items = (o.items || '').trim().replace(/‚úÖ /g, '').split('\n').filter(Boolean);
        const itemsHTML = items.map(it => `<span style="display:inline-block;background:#f0f0f0;border-radius:8px;padding:2px 8px;font-size:12px;margin:2px;">${it}</span>`).join('');

        const ehFiado = (o.payment_method || '').toUpperCase() === 'FIADO';
        const isCardapio = !(o.items || '').includes('‚úÖ');

        const pagamentoBadge = ehFiado
            ? `<span style="background:#fff0f0;color:#e74c3c;font-size:11px;font-weight:700;padding:3px 10px;border-radius:20px;">‚è≥ Pagar Depois${isCardapio ? ' ü§ñ' : ''}</span>`
            : `<span style="background:#e8faf0;color:#27ae60;font-size:11px;font-weight:700;padding:3px 10px;border-radius:20px;">‚úÖ ${o.payment_method || 'Pago'}</span>`;

        const borderColor = ehFiado ? '#e74c3c' : '#27ae60';
        const valorColor  = ehFiado ? '#e74c3c' : '#27ae60';

        const cancelBtn = ehFiado
            ? `<button onclick="cancelarPedidoFiado('${o.id}')" style="background:#fff0f0;border:1.5px solid #e74c3c;color:#e74c3c;border-radius:12px;padding:7px 14px;font-size:12px;font-weight:700;cursor:pointer;white-space:nowrap;">üóëÔ∏è Cancelar</button>`
            : `<button onclick="marcarNaoPagou('${o.id}')" style="background:#fff8ee;border:1.5px solid #e67e22;color:#e67e22;border-radius:12px;padding:7px 14px;font-size:12px;font-weight:700;cursor:pointer;white-space:nowrap;">‚ùå N√£o Pagou</button>`;

        return `
        <div id="hist_${o.id}" style="background:white;border-radius:18px;padding:16px;margin-bottom:12px;box-shadow:0 2px 10px rgba(0,0,0,0.06);border-left:4px solid ${borderColor};">
            <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px;">
                <div>
                    <div style="font-weight:800;font-size:15px;color:#222;">üë§ ${o.customer_name}</div>
                    <div style="font-size:12px;color:#999;margin-top:2px;">üìû ${o.customer_phone || '‚Äî'}</div>
                </div>
                <div style="text-align:right;">
                    <div style="font-size:20px;font-weight:900;color:${valorColor};">R$ ${Number(o.total).toFixed(2).replace('.', ',')}</div>
                    <div style="font-size:11px;color:#aaa;">${dateStr} √†s ${timeStr}</div>
                </div>
            </div>
            <div style="margin-top:8px;line-height:1.8;">${itemsHTML}</div>
            <div style="margin-top:12px;display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap;">
                <div style="display:flex;gap:6px;flex-wrap:wrap;">${pagamentoBadge}</div>
                ${cancelBtn}
            </div>
        </div>`;
    }).join('');

    list.innerHTML = html;
}

function marcarNaoPagou(orderId) {
    const o = historicoMap[orderId];
    if (!o) return;
    showToast({
        type: 'confirm',
        title: `‚ùå N√£o pagou? Pedido de ${o.customer_name}`,
        body: `Itens: ${(o.items||'').replace(/‚úÖ /g,'').replace(/\n/g,', ').trim()}\n\nO pedido de R$ ${Number(o.total).toFixed(2).replace('.', ',')} ser√° convertido para Pagar Depois.`,
        actions: [
            { label: 'Cancelar', bg: '#f0f0f0', color: '#555', fn: 'closeToast()' },
            { label: '‚ùå Confirmar', bg: '#e67e22', color: 'white', fn: `executarNaoPagou('${orderId}')` }
        ],
        duration: 8000
    });
}

async function executarNaoPagou(orderId) {
    closeToast();
    const o = historicoMap[orderId];
    if (!o) return;

    // Atualiza o pedido para FIADO
    await sb.from("orders").update({ payment_method: 'FIADO' }).eq("id", orderId);

    // Adiciona a d√≠vida ao cliente
    const { data: c } = await sb.from("clients").select("debt, name").eq("phone", o.customer_phone).single();
    if (c) {
        const novaDiv = (c.debt || 0) + Number(o.total);
        await sb.from("clients").update({ debt: novaDiv }).eq("phone", o.customer_phone);
    }

    // Atualiza localmente
    o.payment_method = 'FIADO';
    _historicoAllData = _historicoAllData.map(x => x.id === orderId ? {...x, payment_method: 'FIADO'} : x);

    updateFiadoHeader();
    renderHistoricoList(_historicoAllData);
    showToast({ type: 'warning', title: '‚ö†Ô∏è Marcado como Pagar Depois!', body: `R$ ${Number(o.total).toFixed(2).replace('.', ',')} adicionado ao fiado de ${o.customer_name}.`, duration: 5000 });
}

function cancelarPedidoFiado(orderId) {
    const o = historicoMap[orderId];
    if (!o) return;
    const isFiado = (o.payment_method || '').toUpperCase() === 'FIADO';
    const bodyMsg = isFiado
        ? `Itens: ${(o.items||'').replace(/‚úÖ /g,'').replace(/\n/g,', ').trim()}\n\nO valor de R$ ${Number(o.total).toFixed(2).replace('.', ',')} ser√° estornado do pagar depois.`
        : `Itens: ${(o.items||'').replace(/‚úÖ /g,'').replace(/\n/g,', ').trim()}\n\nPedido de R$ ${Number(o.total).toFixed(2).replace('.', ',')} ser√° removido do hist√≥rico.`;
    showToast({
        type: 'confirm',
        title: `‚ùå Remover pedido de ${o.customer_name}?`,
        body: bodyMsg,
        actions: [
            { label: 'N√£o', bg: '#f0f0f0', color: '#555', fn: 'closeToast()' },
            { label: 'üóëÔ∏è Confirmar', bg: 'var(--danger)', color: 'white', fn: `executarCancelamento('${orderId}')` }
        ],
        duration: 8000
    });
}

async function executarCancelamento(orderId) {
    closeToast();
    const o = historicoMap[orderId];
    if (!o) return;

    // Remove o pedido
    await sb.from("orders").delete().eq("id", orderId);

    const isFiado = (o.payment_method || '').toUpperCase() === 'FIADO';

    // S√≥ estorna o fiado se o pedido era fiado
    if (isFiado) {
        const { data: c } = await sb.from("clients").select("debt, name").eq("phone", o.customer_phone).single();
        if (c) {
            const saldoAntes = c.debt || 0;
            const novaDiv = saldoAntes - Number(o.total);
            await sb.from("clients").update({ debt: novaDiv }).eq("phone", o.customer_phone);

            // Registra o reembolso na tabela payments
            await sb.from("payments").insert({
                client_name: c.name || o.customer_name,
                client_phone: o.customer_phone,
                amount: Number(o.total),
                saldo_anterior: saldoAntes,
                saldo_posterior: novaDiv,
                tipo: "reembolso"
            });
        }
    }

    // Remove do mapa e da lista global
    delete historicoMap[orderId];
    _historicoAllData = _historicoAllData.filter(x => x.id !== orderId);

    // Anima e remove o card
    const card = document.getElementById('hist_' + orderId);
    if (card) {
        card.style.transition = 'opacity 0.3s, transform 0.3s';
        card.style.opacity = '0';
        card.style.transform = 'translateX(30px)';
        setTimeout(() => card.remove(), 300);
    }

    updateFiadoHeader();
    const msg = isFiado
        ? `R$ ${Number(o.total).toFixed(2).replace('.', ',')} estornado do pagar depois de ${o.customer_name}.`
        : `Pedido de ${o.customer_name} removido do hist√≥rico.`;
    showToast({ type: 'success', title: '‚úÖ Pedido removido!', body: msg, duration: 5000 });
}

// ===== PAINEL DE ROTAS INTELIGENTE =====

// Coordenadas da f√°brica üè≠
const FABRICA_LAT = -8.1837523;
const FABRICA_LON = -34.9383004;

let rotaAtualId = null;
let rotaParadas = [];
let clientesCache = [];
let mediaMinPorParada = 12;
let gpsEnvios = 0;
let monitorInterval = null;
let estavaNaFabrica = null;
let rotasHoje = [];
let filaRotas = [];
let rotaAtualObj = null;

function calcDistM(lat1, lon1, lat2, lon2) {
    const R = 6371000;
    const dLat = (lat2-lat1)*Math.PI/180;
    const dLon = (lon2-lon1)*Math.PI/180;
    const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
    return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}

function diaHoje() { return ['Dom','Seg','Ter','Qua','Qui','Sex','S√°b'][new Date().getDay()]; }
function horaAtual() { return new Date().toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'}); }

async function loadRotasPanel() {
    const { data: clients } = await sb.from("clients").select("*").order("name");
    clientesCache = clients || [];
    await preencherClientesComPedido();
    await calcularMediaEta();
    await carregarRotasHoje();
    await carregarRotasSalvas();
    // Monitor j√° iniciado no background ‚Äî s√≥ reinicia se por algum motivo parou
    if (watchId === null) iniciarMonitorFabrica();
}

async function preencherClientesComPedido() {
    // Busca pedidos de hoje (payment_method !== 'FIADO' j√° pago, ou qualquer pedido do dia)
    const hoje = new Date().toISOString().split('T')[0];
    const { data: pedidosHoje } = await sb.from("orders")
        .select("customer_phone, customer_name")
        .gte("created_at", hoje + 'T00:00:00')
        .lte("created_at", hoje + 'T23:59:59');

    // Monta set de phones com pedido hoje
    const phonesComPedido = new Set((pedidosHoje || []).map(p => p.customer_phone));

    const sel = document.getElementById('paradaCliente');
    const clientesComPedido = clientesCache.filter(c => phonesComPedido.has(c.phone));
    const clientesSemPedido = clientesCache.filter(c => !phonesComPedido.has(c.phone));

    sel.innerHTML = '<option value="">-- Selecionar cliente --</option>';

    if (clientesComPedido.length > 0) {
        const grpPedido = document.createElement('optgroup');
        grpPedido.label = `‚úÖ Com pedido hoje (${clientesComPedido.length})`;
        clientesComPedido.forEach(c => {
            const o = document.createElement('option');
            o.value = c.phone; o.dataset.name = c.name; o.textContent = c.name;
            grpPedido.appendChild(o);
        });
        sel.appendChild(grpPedido);
    }

    if (clientesSemPedido.length > 0) {
        const grpSem = document.createElement('optgroup');
        grpSem.label = `‚Äî Sem pedido hoje`;
        clientesSemPedido.forEach(c => {
            const o = document.createElement('option');
            o.value = c.phone; o.dataset.name = c.name;
            o.textContent = c.name; o.style.color = '#aaa';
            grpSem.appendChild(o);
        });
        sel.appendChild(grpSem);
    }
}

async function carregarRotasHoje() {
    const dia = diaHoje();
    const { data: todasRotas } = await sb.from("delivery_routes").select("*").order("hora_saida",{ascending:true});
    rotasHoje = (todasRotas||[]).filter(r => r.dias_semana && r.dias_semana.includes(dia));
    filaRotas = rotasHoje.filter(r => r.status !== 'concluido').sort((a,b)=>(a.hora_saida||'00:00').localeCompare(b.hora_saida||'00:00'));
    const emAndamento = rotasHoje.find(r => r.status === 'em_andamento');
    if (emAndamento) {
        rotaAtualId = emAndamento.id;
        rotaAtualObj = emAndamento;
        rotaParadas = emAndamento.paradas || [];
        mostrarGpsAtivo(emAndamento);
    }
    renderRotasHoje();
}

function renderRotasHoje() {
    const list = document.getElementById('rotasHojeList');
    if (!rotasHoje || rotasHoje.length === 0) {
        list.innerHTML = '<div style="text-align:center;color:#aaa;font-size:13px;padding:10px;">Nenhuma rota para hoje.<br>Crie uma usando ‚ûï Nova</div>';
        return;
    }
    const corStatus = { criada:'#f1c40f', aguardando:'#3498db', em_andamento:'#27ae60', concluido:'#95a5a6' };
    const labelStatus = { criada:'‚è≥ Aguardando hor√°rio', aguardando:'üè≠ Aguardando sa√≠da', em_andamento:'üõµ Em andamento', concluido:'‚úÖ Conclu√≠da' };
    list.innerHTML = rotasHoje.map(r => {
        const entregues = (r.paradas||[]).filter(p=>p.status==='entregue').length;
        const total = (r.paradas||[]).length;
        const cor = corStatus[r.status]||'#ccc';
        const pulse = r.status==='aguardando'?'animation:aguardandoPulse 1.5s ease-in-out infinite;':'';
        return `<div style="background:#f8f9fa;border-radius:12px;padding:12px;border-left:4px solid ${cor};margin-bottom:4px;">
            <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:8px;">
                <div style="flex:1;">
                    <div style="font-weight:800;font-size:14px;">${r.nome}</div>
                    <div style="font-size:11px;color:#aaa;margin-top:2px;">‚è∞ ${r.hora_saida||'--'} ¬∑ Raio: ${r.raio_fabrica||20}m</div>
                    <div style="font-size:12px;font-weight:700;color:${cor};margin-top:4px;${pulse}">${labelStatus[r.status]||r.status}</div>
                    ${total>0?`<div style="font-size:11px;color:#888;margin-top:2px;">üì¶ ${entregues}/${total} entregas</div>`:''}
                </div>
                <div style="display:flex;flex-direction:column;gap:4px;align-items:flex-end;">
                    <button onclick="abrirParadasRota('${r.id}')" style="padding:5px 10px;background:${cor};color:white;border:none;border-radius:8px;font-size:11px;font-weight:700;cursor:pointer;">üìã Paradas</button>
                    ${r.status==='criada'?`<button onclick="excluirRota('${r.id}')" style="padding:5px 10px;background:#fee;color:#e74c3c;border:1px solid #fcc;border-radius:8px;font-size:11px;cursor:pointer;">‚úï</button>`:''}
                </div>
            </div>
        </div>`;
    }).join('');
}

let watchId = null;
let ultimoTickMs = 0;
const TICK_INTERVALO_MS = 5000;

let ultimaPosCapturada = null; // guarda √∫ltima posi√ß√£o para reenvio for√ßado

function iniciarMonitorFabrica() {
    if (!navigator.geolocation) return;
    if (watchId !== null) navigator.geolocation.clearWatch(watchId);
    clearInterval(monitorInterval);
    document.getElementById('fabricaStatusCard').style.display = 'block';

    // watchPosition ‚Äî captura movimento
    watchId = navigator.geolocation.watchPosition(async pos => {
        ultimaPosCapturada = pos;
        await processarPosicao(pos);
    }, (err) => { console.warn('GPS erro:', err); }, {enableHighAccuracy:true, timeout:15000, maximumAge:3000});

    // Intervalo for√ßado a cada 3s ‚Äî garante envio mesmo parado
    monitorInterval = setInterval(async () => {
        if (ultimaPosCapturada) {
            await enviarPosicaoGPS(
                ultimaPosCapturada.coords.latitude,
                ultimaPosCapturada.coords.longitude,
                ultimaPosCapturada.coords.accuracy
            );
        } else {
            // Sem posi√ß√£o ainda ‚Äî tenta buscar
            navigator.geolocation.getCurrentPosition(async pos => {
                ultimaPosCapturada = pos;
                await processarPosicao(pos);
            }, null, {enableHighAccuracy:true, timeout:5000, maximumAge:3000});
        }
    }, 3000);
}

async function processarPosicao(pos) {
    const agora = Date.now();
    if (agora - ultimoTickMs < TICK_INTERVALO_MS) {
        // Mesmo com throttle, ainda envia GPS
        await enviarPosicaoGPS(pos.coords.latitude, pos.coords.longitude, pos.coords.accuracy);
        return;
    }
    ultimoTickMs = agora;

    const lat = pos.coords.latitude;
    const lon = pos.coords.longitude;
    const raio = parseInt(document.getElementById('rotaRaio')?.value) || 20;
    const dist = Math.round(calcDistM(lat, lon, FABRICA_LAT, FABRICA_LON));
    const naFabrica = dist <= raio;

    atualizarCardFabrica(naFabrica, dist);

    if (estavaNaFabrica === true && !naFabrica) await tentarIniciarProximaRota();
    if (estavaNaFabrica === false && naFabrica && rotaAtualId) await encerrarRotaAutomatico();
    estavaNaFabrica = naFabrica;

    if (rotaAtualId && rotaParadas.length > 0) await monitorarParadaAtual(lat, lon);

    await enviarPosicaoGPS(lat, lon, pos.coords.accuracy);
}

function tickMonitor() {} // mantido por compatibilidade

// Controle de presen√ßa nas paradas
let paradaAtualId = null;
let estavaNaParada = false;

async function monitorarParadaAtual(lat, lon) {
    const proxima = rotaParadas.find(p => p.status === 'pendente' && p.coords);
    if (!proxima) return;

    const raio = parseInt(document.getElementById('rotaRaio')?.value) || 20;
    const dist = Math.round(calcDistM(lat, lon, proxima.coords[0], proxima.coords[1]));
    const naParada = dist <= raio;

    // Entrou na √°rea do cliente
    if (!estavaNaParada && naParada && paradaAtualId !== proxima.id) {
        paradaAtualId = proxima.id;
        estavaNaParada = true;
        showToast({
            type: 'success',
            title: '\uD83D\uDCCD Chegou em ' + proxima.nome + '!',
            body: 'A ' + dist + 'm ¬∑ Realize a entrega e saia da √°rea para confirmar.',
            duration: 5000
        });
        atualizarCardParada(proxima, dist, true);
    }

    // Saiu da √°rea ‚Üí entrega confirmada automaticamente
    if (estavaNaParada && !naParada && paradaAtualId === proxima.id) {
        estavaNaParada = false;
        paradaAtualId = null;
        await marcarEntregue(proxima.id);
        const proxNome = rotaParadas.find(p => p.status === 'pendente' && p.id !== proxima.id && p.coords)?.nome;
        showToast({
            type: 'success',
            title: '\u2705 Entrega confirmada!',
            body: proxNome
                ? proxima.nome + ' \u2713 ¬∑ Pr√≥ximo: ' + proxNome
                : proxima.nome + ' \u2713 ¬∑ Todas as entregas conclu√≠das!',
            duration: 5000
        });
        atualizarCardParada(null, 0, false);
    }

    // Atualiza dist√¢ncia enquanto se aproxima
    if (!naParada && !estavaNaParada) {
        atualizarCardParada(proxima, dist, false);
    }
}

function atualizarCardParada(parada, dist, chegou) {
    const sub = document.getElementById('fabricaStatusSub');
    const titulo = document.getElementById('fabricaStatusTitulo');
    if (!parada) return;
    const raio = parseInt(document.getElementById('rotaRaio')?.value) || 20;
    if (chegou) {
        titulo.textContent = '\uD83D\uDCCD Na √°rea de ' + parada.nome;
        sub.textContent = 'Saia dos ' + raio + 'm ap√≥s entregar para confirmar automaticamente';
        sub.style.animation = 'aguardandoPulse 1.5s ease-in-out infinite';
    } else {
        titulo.textContent = '\uD83D\uDEF5 Indo para ' + parada.nome;
        sub.textContent = dist + 'm de dist√¢ncia ¬∑ Raio de confirma√ß√£o: ' + raio + 'm';
        sub.style.animation = '';
    }
}

function atualizarCardFabrica(naFabrica, dist) {
    const card = document.getElementById('fabricaStatusCard');
    const titulo = document.getElementById('fabricaStatusTitulo');
    const sub = document.getElementById('fabricaStatusSub');
    const badge = document.getElementById('fabricaDistBadge');
    const proximaInfo = document.getElementById('proximaRotaInfo');

    badge.textContent = dist + 'm da f√°brica';

    if (naFabrica) {
        card.style.background = 'linear-gradient(135deg,#1a3a2e,#0d2a1e)';
        card.style.border = '1px solid rgba(39,174,96,0.4)';
        document.getElementById('fabricaStatusIcon').textContent = 'üè≠';
        titulo.textContent = 'Voc√™ est√° na f√°brica';
        sub.textContent = 'Aguardando voc√™ sair para iniciar a rota...';
        sub.style.animation = 'aguardandoPulse 1.5s ease-in-out infinite';
        const proxima = getProximaRotaPendente();
        if (proxima) {
            proximaInfo.style.display = 'block';
            proximaInfo.innerHTML = `üõµ Pr√≥xima: <strong>${proxima.nome}</strong> ¬∑ ‚è∞ ${proxima.hora_saida} ¬∑ ${(proxima.paradas||[]).length} paradas`;
        } else { proximaInfo.style.display = 'none'; }
    } else {
        card.style.background = 'linear-gradient(135deg,#1a1a2e,#2d1f4e)';
        card.style.border = '1px solid rgba(52,152,219,0.3)';
        document.getElementById('fabricaStatusIcon').textContent = rotaAtualId ? 'üõµ' : 'üìç';
        titulo.textContent = rotaAtualId ? 'Entrega em andamento' : 'Fora da f√°brica';
        sub.textContent = rotaAtualId ? `Rota: ${rotaAtualObj?.nome||''}` : `${dist}m ‚Äî volte √† f√°brica para encerrar`;
        sub.style.animation = '';
        proximaInfo.style.display = 'none';
    }
}

function getProximaRotaPendente() {
    if (rotaAtualId) return null;
    const agora = horaAtual();
    return filaRotas.find(r => r.status === 'criada' && (r.hora_saida||'00:00') <= agora) || null;
}

async function tentarIniciarProximaRota() {
    const proxima = getProximaRotaPendente();
    if (!proxima) return;
    await sb.from("delivery_routes").update({status:'em_andamento', saida_em:new Date().toISOString()}).eq("id", proxima.id);
    rotaAtualId = proxima.id;
    rotaAtualObj = {...proxima, status:'em_andamento'};
    rotaParadas = proxima.paradas || [];
    filaRotas = filaRotas.filter(r => r.id !== proxima.id);
    mostrarGpsAtivo(rotaAtualObj);
    await carregarRotasHoje();
    showToast({type:'success', title:`üõµ ${proxima.nome} iniciada!`, body:`Saiu √†s ${horaAtual()}. GPS ativo.`, duration:5000});
}

async function encerrarRotaAutomatico() {
    if (!rotaAtualId) return;
    await sb.from("delivery_routes").update({status:'concluido', fim_em:new Date().toISOString()}).eq("id", rotaAtualId);
    await sb.from("config").upsert({key:"admin_gps", value:JSON.stringify({lat:null,lon:null,ts:null})},{onConflict:'key'});
    const nome = rotaAtualObj?.nome || 'Rota';
    rotaAtualId = null; rotaAtualObj = null; rotaParadas = [];
    document.getElementById('gpsTransmitindoBanner').style.display = 'none';
    await carregarRotasHoje();
    await carregarRotasSalvas();
    showToast({type:'success', title:`‚úÖ ${nome} encerrada!`, body:`Chegou na f√°brica √†s ${horaAtual()}. Pr√≥xima rota aguardando...`, duration:5000});
}

async function encerrarRotaManual() {
    await encerrarRotaAutomatico();
}

function mostrarGpsAtivo(rota) {
    document.getElementById('gpsTransmitindoBanner').style.display = 'block';
    document.getElementById('gpsRotaNomeAtiva').textContent = `üõµ ${rota.nome}`;
    const list = document.getElementById('paradasEmAndamentoList');
    list.innerHTML = (rota.paradas||[]).map((p,i) => `
        <div style="display:flex;align-items:center;gap:8px;padding:6px 8px;background:rgba(255,255,255,0.08);border-radius:10px;">
            <div style="width:22px;height:22px;border-radius:50%;background:${p.status==='entregue'?'#27ae60':'rgba(255,255,255,0.2)'};display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:900;color:white;flex-shrink:0;">${p.status==='entregue'?'‚úì':i+1}</div>
            <div style="flex:1;font-size:12px;font-weight:700;color:white;">${p.nome} <span style="font-size:10px;color:rgba(255,255,255,0.45);">~${p.eta_min}min</span></div>
            ${p.status!=='entregue'?`<button onclick="marcarEntregue('${p.id}')" style="padding:3px 8px;background:rgba(39,174,96,0.4);color:#2ecc71;border:1px solid rgba(39,174,96,0.5);border-radius:8px;font-size:10px;font-weight:700;cursor:pointer;">‚úì</button>`:''}
        </div>`).join('');
}

async function enviarPosicaoGPS(lat, lon, precisao) {
    const ts = new Date().toISOString();
    // Sempre salva posi√ß√£o na tabela config ‚Äî card√°pio l√™ daqui em tempo real
    await sb.from("config").upsert(
        {key:"admin_gps", value:JSON.stringify({lat, lon, ts, precisao, rota_id: rotaAtualId || null})},
        {onConflict:'key'}
    );
    // Se tiver rota ativa, salva tamb√©m na rota
    if (rotaAtualId) {
        await sb.from("delivery_routes").update({posicao_entregador:{lat,lon,ts,precisao}}).eq("id",rotaAtualId);
    }
    gpsEnvios++;
    const hora = new Date(ts).toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
    const elPos = document.getElementById('gpsUltimaPos');
    const elCount = document.getElementById('gpsContadorEnvios');
    if (elPos) elPos.textContent = `üìç ${lat.toFixed(5)}, ${lon.toFixed(5)} ¬∑ ${Math.round(precisao||0)}m`;
    if (elCount) elCount.textContent = `${gpsEnvios} atualiza√ß√µes ¬∑ √∫ltima √†s ${hora}`;
}

function toggleNovaRota() {
    const f = document.getElementById('novaRotaForm');
    f.style.display = f.style.display === 'none' ? 'block' : 'none';
}

function toggleDia(el, dia) {
    const ativo = el.dataset.ativo === 'true';
    el.dataset.ativo = ativo ? 'false' : 'true';
    el.style.border = ativo ? '2px solid #eee' : '2px solid #27ae60';
    el.style.background = ativo ? '#fafafa' : 'linear-gradient(135deg,#e8f5e9,#f1fff4)';
    el.querySelector('div').style.color = ativo ? '#aaa' : '#27ae60';
}

function getDiasSelecionados() {
    return [...document.querySelectorAll('[data-dia]')].filter(el=>el.dataset.ativo==='true').map(el=>el.dataset.dia);
}

async function criarRota() {
    const nome = document.getElementById('rotaNome').value.trim();
    const hora = document.getElementById('rotaHoraSaida').value;
    const raio = parseInt(document.getElementById('rotaRaio').value)||20;
    const dias = getDiasSelecionados();
    if (!nome) return showToast({type:'confirm',title:'‚ö†Ô∏è',body:'Digite o nome da rota.',duration:2500});
    if (dias.length===0) return showToast({type:'confirm',title:'‚ö†Ô∏è',body:'Selecione pelo menos um dia.',duration:2500});
    const {data:nova,error} = await sb.from("delivery_routes").insert({nome,dias_semana:dias,hora_saida:hora,raio_fabrica:raio,status:'criada',paradas:[]}).select().single();
    if (error||!nova) return showToast({type:'confirm',title:'‚ùå Erro',body:'Verifique se rodou o SQL: ALTER TABLE delivery_routes ADD COLUMN IF NOT EXISTS raio_fabrica int DEFAULT 20;',duration:4000});
    document.getElementById('novaRotaForm').style.display = 'none';
    document.getElementById('rotaNome').value = '';
    document.querySelectorAll('[data-dia]').forEach(el => {
        el.dataset.ativo='false'; el.style.border='2px solid #eee';
        el.style.background='#fafafa'; el.querySelector('div').style.color='#aaa';
    });
    await carregarRotasHoje();
    await carregarRotasSalvas();
    showToast({type:'success',title:'‚úÖ Rota criada!',body:`"${nome}" ‚Äî ${dias.join(', ')} √†s ${hora}`,duration:3000});
}

async function abrirParadasRota(rotaId) {
    const {data:r} = await sb.from("delivery_routes").select("*").eq("id",rotaId).single();
    if (!r) return;
    rotaAtualId = rotaId;
    rotaParadas = r.paradas||[];
    document.getElementById('rotaAtualNomeLabel').textContent = r.nome;
    document.getElementById('addParadaRotaNome').textContent = r.nome;
    document.getElementById('rotaAtualBox').style.display = 'block';
    document.getElementById('addParadaBox').style.display = 'block';
    renderParadasList();
    window.scrollTo({top:0,behavior:'smooth'});
}

function fecharRotaAtual() {
    document.getElementById('rotaAtualBox').style.display='none';
    document.getElementById('addParadaBox').style.display='none';
    if (rotaAtualObj) rotaAtualId = rotaAtualObj.id; else rotaAtualId = null;
}

function fecharAddParada() { document.getElementById('addParadaBox').style.display='none'; }

async function calcularMediaEta() {
    const ontem = new Date(); ontem.setDate(ontem.getDate()-1);
    const ontemStr = ontem.toISOString().split('T')[0];
    const {data:hist} = await sb.from("delivery_routes").select("paradas,saida_em,fim_em")
        .gte("created_at",ontemStr+'T00:00:00').lte("created_at",ontemStr+'T23:59:59')
        .eq("status","concluido").limit(5);
    if (hist && hist.length>0) {
        const tempos = hist.filter(h=>h.saida_em&&h.fim_em&&h.paradas?.length>0)
            .map(h=>(new Date(h.fim_em)-new Date(h.saida_em))/60000/h.paradas.length);
        if (tempos.length>0) { mediaMinPorParada=tempos.reduce((a,b)=>a+b,0)/tempos.length; return; }
    }
    mediaMinPorParada = 12;
}

function onParadaClienteChange() {
    const sel = document.getElementById('paradaCliente');
    const opt = sel.options[sel.selectedIndex];
    const info = document.getElementById('paradaClienteInfo');
    if (opt.value) {
        const c = clientesCache.find(x=>x.phone===opt.value);
        if (c) {
            const debt = c.debt>0?`üí∏ Deve R$ ${c.debt.toFixed(2)}`:c.debt<0?`‚úÖ Cr√©dito R$ ${Math.abs(c.debt).toFixed(2)}`:'‚úÖ Em dia';
            info.style.display='block'; info.textContent=`üì± ${c.phone} ¬∑ ${debt}`;
        }
        mostrarEtaPreview();
    } else { info.style.display='none'; document.getElementById('paradaEtaPreview').style.display='none'; }
}

function mostrarEtaPreview() {
    const num = rotaParadas.length+1;
    const eta = Math.round(num*mediaMinPorParada);
    document.getElementById('paradaEtaPreview').style.display='block';
    document.getElementById('paradaEtaValor').textContent=eta+' min';
    document.getElementById('paradaEtaHistorico').textContent=`Parada #${num} ¬∑ M√©dia: ${mediaMinPorParada.toFixed(0)} min/entrega`;
}

function usarEnderecoAtual() {
    if (!navigator.geolocation) return alert('Geolocaliza√ß√£o n√£o suportada');
    navigator.geolocation.getCurrentPosition(pos => {
        document.getElementById('paradaLat').value=pos.coords.latitude.toFixed(6);
        document.getElementById('paradaLon').value=pos.coords.longitude.toFixed(6);
        showToast({type:'success',title:'üìç Localiza√ß√£o capturada!',body:'Coordenadas preenchidas.',duration:2500});
    }, ()=>alert('N√£o foi poss√≠vel obter localiza√ß√£o'));
}

async function adicionarParada() {
    if (!rotaAtualId) return showToast({type:'confirm',title:'‚ö†Ô∏è',body:'Selecione uma rota primeiro.',duration:2500});
    const sel = document.getElementById('paradaCliente');
    const endereco = document.getElementById('paradaEndereco').value.trim();
    const lat = parseFloat(document.getElementById('paradaLat').value);
    const lon = parseFloat(document.getElementById('paradaLon').value);
    const clientePhone = sel.value;
    const clienteNome = sel.options[sel.selectedIndex]?.dataset?.name||'';
    if (!clientePhone && !endereco) return showToast({type:'confirm',title:'‚ö†Ô∏è',body:'Selecione cliente ou informe endere√ßo.',duration:2500});

    // Verifica se o cliente tem pedido hoje
    if (clientePhone) {
        const hoje = new Date().toISOString().split('T')[0];
        const { data: pedido } = await sb.from("orders")
            .select("id").eq("customer_phone", clientePhone)
            .gte("created_at", hoje + 'T00:00:00')
            .lte("created_at", hoje + 'T23:59:59')
            .limit(1);
        if (!pedido || pedido.length === 0) {
            return showToast({type:'confirm', title:'‚ö†Ô∏è Sem pedido', body:`${clienteNome} n√£o fez pedido hoje. N√£o √© poss√≠vel adicionar √† rota.`, duration:4000});
        }
    }
    const parada = {
        id: Date.now().toString(), cliente_phone:clientePhone,
        nome:clienteNome||'Sem nome',
        endereco:endereco||`${lat.toFixed(4)}, ${lon.toFixed(4)}`,
        coords:(!isNaN(lat)&&!isNaN(lon))?[lat,lon]:null,
        eta_min:Math.round((rotaParadas.length+1)*mediaMinPorParada),
        status:'pendente'
    };
    rotaParadas.push(parada);
    await sb.from("delivery_routes").update({paradas:rotaParadas}).eq("id",rotaAtualId);
    sel.value=''; document.getElementById('paradaEndereco').value='';
    document.getElementById('paradaLat').value=''; document.getElementById('paradaLon').value='';
    document.getElementById('paradaClienteInfo').style.display='none';
    document.getElementById('paradaEtaPreview').style.display='none';
    renderParadasList();
    if (rotaAtualObj?.id===rotaAtualId) mostrarGpsAtivo({...rotaAtualObj,paradas:rotaParadas});
    showToast({type:'success',title:'üìç Parada adicionada!',body:`${parada.nome} na rota.`,duration:2000});
}

function renderParadasList() {
    const list = document.getElementById('rotaParadasList');
    if (rotaParadas.length===0) {
        list.innerHTML='<div style="text-align:center;color:#aaa;padding:20px;font-size:13px;">Nenhuma parada ainda</div>';
        document.getElementById('rotaResumoEta').style.display='none'; return;
    }
    list.innerHTML = rotaParadas.map((p,i)=>`
        <div style="background:#f8f9fa;border-radius:12px;padding:10px 12px;display:flex;gap:10px;align-items:center;border-left:4px solid ${p.status==='entregue'?'#27ae60':'#3498db'};">
            <div style="width:28px;height:28px;border-radius:50%;background:${p.status==='entregue'?'#27ae60':'#3498db'};display:flex;align-items:center;justify-content:center;color:white;font-weight:900;font-size:13px;flex-shrink:0;">${p.status==='entregue'?'‚úì':i+1}</div>
            <div style="flex:1;min-width:0;">
                <div style="font-weight:700;font-size:13px;">${p.nome}</div>
                <div style="font-size:11px;color:#aaa;">üìç ${p.endereco} ¬∑ ‚è±Ô∏è ~${p.eta_min}min</div>
            </div>
            <div style="display:flex;gap:4px;">
                ${p.status!=='entregue'?`<button onclick="marcarEntregue('${p.id}')" style="padding:4px 8px;background:#e8f5e9;color:#27ae60;border:1px solid #c8e6c9;border-radius:8px;font-size:11px;font-weight:700;cursor:pointer;">‚úì</button>`:''}
                <button onclick="removerParada('${p.id}')" style="padding:4px 8px;background:#fee;color:#e74c3c;border:1px solid #fcc;border-radius:8px;font-size:11px;cursor:pointer;">‚úï</button>
            </div>
        </div>`).join('');
    const totalMin = Math.round(rotaParadas.length*mediaMinPorParada);
    document.getElementById('rotaResumoEta').style.display='block';
    document.getElementById('rotaResumoTexto').textContent=`${rotaParadas.length} paradas ¬∑ ~${totalMin} min total ¬∑ ${mediaMinPorParada.toFixed(0)} min/entrega`;
}

async function marcarEntregue(paradaId) {
    const p = rotaParadas.find(x=>x.id===paradaId);
    if (p) p.status='entregue';
    await sb.from("delivery_routes").update({paradas:rotaParadas}).eq("id",rotaAtualId);
    renderParadasList();
    if (rotaAtualObj?.id===rotaAtualId) mostrarGpsAtivo({...rotaAtualObj,paradas:rotaParadas});
}

async function removerParada(paradaId) {
    rotaParadas = rotaParadas.filter(p=>p.id!==paradaId);
    rotaParadas.forEach((p,i)=>{ p.eta_min=Math.round((i+1)*mediaMinPorParada); });
    await sb.from("delivery_routes").update({paradas:rotaParadas}).eq("id",rotaAtualId);
    renderParadasList();
}

async function excluirRota(rotaId) {
    await sb.from("delivery_routes").delete().eq("id",rotaId);
    await carregarRotasHoje();
    await carregarRotasSalvas();
}

async function carregarRotasSalvas() {
    const {data:rotas} = await sb.from("delivery_routes").select("*").order("created_at",{ascending:false}).limit(30);
    const list = document.getElementById('rotasSalvasList');
    if (!rotas||rotas.length===0) { list.innerHTML='<div style="text-align:center;color:#aaa;padding:20px;font-size:13px;">Nenhuma rota salva</div>'; return; }
    const corS={criada:'#f1c40f',aguardando:'#3498db',em_andamento:'#27ae60',concluido:'#95a5a6'};
    const labS={criada:'‚è≥ Criada',aguardando:'üè≠ Aguardando',em_andamento:'üõµ Em andamento',concluido:'‚úÖ Conclu√≠da'};
    list.innerHTML = rotas.map(r=>{
        const entregues=(r.paradas||[]).filter(p=>p.status==='entregue').length;
        const total=(r.paradas||[]).length;
        const dur=(r.saida_em&&r.fim_em)?Math.round((new Date(r.fim_em)-new Date(r.saida_em))/60000)+' min':'--';
        const cor=corS[r.status]||'#ccc';
        return `<div style="background:#f8f9fa;border-radius:12px;padding:12px;margin-bottom:8px;border-left:4px solid ${cor};">
            <div style="display:flex;justify-content:space-between;align-items:flex-start;">
                <div><div style="font-weight:700;font-size:13px;">${r.nome}</div>
                <div style="font-size:11px;color:#aaa;margin-top:2px;">${(r.dias_semana||[]).join(' ')} ¬∑ ‚è∞ ${r.hora_saida||'--'}</div></div>
                <span style="font-size:10px;font-weight:700;padding:3px 8px;border-radius:20px;background:${cor}22;color:${cor};">${labS[r.status]||r.status}</span>
            </div>
            <div style="margin-top:6px;font-size:11px;color:#777;">üì¶ ${entregues}/${total} entregas ¬∑ ‚è±Ô∏è ${dur}</div>
        </div>`;
    }).join('');
}

</script>
</div><!-- /adminApp -->
</body>
</html>
